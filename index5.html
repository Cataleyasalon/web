<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Citas - Limpieza Histórica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados para el calendario */
        :root {
            --primary-dark: #1f2937; /* Gray-800 */
            --secondary-dark: #374151; /* Gray-700 */
            --accent: #ef4444; /* Red-500 */
            --occupied-day: #10b981; /* Emerald-500 */
        }
        body {
            background-color: var(--primary-dark);
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .view-container {
            background-color: var(--secondary-dark);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day-cell {
            background-color: var(--secondary-dark);
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            transition: background-color 0.15s;
        }
        .day-name {
            height: 30px;
            background-color: var(--primary-dark);
            color: var(--accent);
            cursor: default;
        }
        .day-cell.disabled {
            cursor: not-allowed;
            background-color: var(--primary-dark);
        }
        .occupied-dot {
            width: 8px;
            height: 8px;
            background-color: var(--occupied-day);
            border-radius: 50%;
            margin-top: 4px;
        }
        .btn-primary {
            background-color: var(--accent);
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #dc2626; /* Red-600 */
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-6 p-4 bg-secondary-dark rounded-lg">
            <h1 class="text-4xl font-extrabold text-white">Gestor de Citas <i class="fas fa-clock text-accent ml-2"></i></h1>
        </header>

        <div id="viewContainer" class="view-container">
            </div>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center hidden z-50" onclick="hideModal()">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800">Mensaje</h3>
                <p id="modalMessage" class="mb-6 text-gray-600"></p>
                <div id="modalActions" class="flex justify-end space-x-3">
                    <button id="modalCloseButton" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition duration-150">Cerrar</button>
                    </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'appointment_manager_data';
        let appointments = [];
        let currentCalendarDate = new Date();
        let currentView = 'home';
        
        const viewContainer = document.getElementById('viewContainer');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');

        // =======================================================
        // UTILIDADES Y FORMATO
        // =======================================================

        function formatDateOnly(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toISOString().substring(0, 10); // YYYY-MM-DD
        }
        
        function formatDateTimeDisplay(dateTimeStr) {
            const date = new Date(dateTimeStr);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
            };
            return date.toLocaleDateString('es-ES', options);
        }

        function showModal(title, message, isError = false, confirmationCallback = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Limpiar acciones previas
            modalActions.innerHTML = '';

            if (confirmationCallback) {
                // Botón de Confirmar
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-150';
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.onclick = () => {
                    confirmationCallback();
                    hideModal();
                };
                modalActions.appendChild(confirmBtn);
            }
            
            // Botón de Cerrar/Cancelar
            const closeBtn = document.createElement('button');
            closeBtn.id = 'modalCloseButton';
            closeBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition duration-150';
            closeBtn.textContent = confirmationCallback ? 'Cancelar' : 'Cerrar';
            closeBtn.onclick = hideModal;
            modalActions.appendChild(closeBtn);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideModal() {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        // =======================================================
        // GESTIÓN DE LOCALSTORAGE - AJUSTADO para MANTENER 2 MESES DE HISTORIAL
        // =======================================================

        function saveAppointments(apts) {
            const data = {
                appointments: apts,
                lastSaveTimestamp: Date.now() 
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
                showModal('Error al guardar datos. El almacenamiento podría estar lleno o desactivado.', true);
            }
        }

        /**
         * Carga las citas y elimina automáticamente aquellas con más de 2 meses de antigüedad.
         * Mantiene el registro histórico de los últimos 3 meses (actual + 2 anteriores).
         */
        function loadAppointments() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (!storedData) {
                    saveAppointments([]);
                    return [];
                }
                
                const data = JSON.parse(storedData);
                
                // 1. CALCULAR LA FECHA LÍMITE (CUTOFF)
                const now = new Date();
                // Creamos la fecha límite: retrocedemos 2 meses y establecemos al día 1 a las 00:00:00
                const cutoffDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                
                // 2. FILTRAR Y ELIMINAR CITAS ANTIGUAS
                const validAppointments = data.appointments.filter(apt => {
                    const aptDate = new Date(apt.dateTime);
                    // La cita es válida si es igual o posterior a la fecha límite
                    return aptDate >= cutoffDate;
                });
                
                if (validAppointments.length !== data.appointments.length) {
                    console.log(`Se eliminaron ${data.appointments.length - validAppointments.length} citas con más de 2 meses de antigüedad.`);
                    // 3. GUARDAR EL RESULTADO FILTRADO
                    saveAppointments(validAppointments);
                }
                
                // 4. DEVOLVER CITAS VÁLIDAS ORDENADAS
                return validAppointments.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            } catch (error) {
                console.error('Error al cargar o analizar localStorage:', error);
                showModal('Error al cargar datos. Los datos de citas podrían estar corruptos.', true);
                return [];
            }
        }

        // =======================================================
        // LÓGICA DE CITAS
        // =======================================================

        function addAppointment(dateStr, timeStr) {
            const [hourStr, minuteStr] = timeStr.split(':');
            let hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);
            
            // Determinar si es AM o PM
            const isPM = hour >= 12 && hour < 24;

            // Construir la fecha completa ISO
            const dateTimeStr = `${dateStr}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:00`;
            const newAppointmentDate = new Date(dateTimeStr);
            const now = new Date();
            
            // Validación 1: No agendar en el pasado
            if (newAppointmentDate <= now) {
                showModal('Error al Agendar', 'No se puede agendar una cita en el pasado.', true);
                return;
            }

            // Validación 2: Chequear disponibilidad
            const isAvailable = appointments.every(apt => {
                const existingDate = new Date(apt.dateTime);
                const diff = Math.abs(newAppointmentDate.getTime() - existingDate.getTime());
                // Asegurar que haya al menos 30 minutos de diferencia (1800000 milisegundos)
                return diff >= (30 * 60 * 1000); 
            });

            if (!isAvailable) {
                showModal('Error al Agendar', 'Ya existe una cita muy cercana a esta hora. Por favor, elige un intervalo de 30 minutos.', true);
                return;
            }

            // Agendar la cita
            const newAppointment = {
                id: Date.now(), // ID único basado en el timestamp
                dateTime: newAppointmentDate.toISOString(), // Guardar en formato ISO
                // Aquí podrías añadir un campo para el nombre del cliente si fuera necesario
            };

            appointments.push(newAppointment);
            saveAppointments(appointments);
            
            showModal('Cita Agendada', `Tu cita ha sido agendada para el ${formatDateTimeDisplay(newAppointment.dateTime)}.`, false);
            
            // Regresar a la vista del calendario
            setView('calendar'); 
        }

        function cancelAppointment(id) {
            // Convertir el ID a número (está como string en el DOM)
            const appointmentId = Number(id); 

            // Filtrar la lista de citas para remover la que coincide con el ID
            const originalLength = appointments.length;
            appointments = appointments.filter(apt => apt.id !== appointmentId);
            
            if (appointments.length < originalLength) {
                saveAppointments(appointments);
                showModal('Cita Cancelada', 'La cita ha sido cancelada exitosamente.', false);
                // Si estamos en la vista de detalle de día, recargarla
                if (currentView === 'dayDetails') {
                     // Asumimos que la fecha se guardó en algún lugar, si no, es un error de diseño.
                     // Para simplificar, regresamos al calendario.
                     setView('calendar');
                } else {
                     setView(currentView);
                }
            } else {
                showModal('Error al Cancelar', 'No se encontró la cita a cancelar.', true);
            }
        }

        // =======================================================
        // VISTAS Y RENDERIZADO
        // =======================================================

        function setView(viewName, data = null) {
            currentView = viewName;
            switch (viewName) {
                case 'home':
                    renderHome();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'dayDetails':
                    showDayDetails(data); // data es la fecha 'YYYY-MM-DD'
                    break;
                case 'schedule':
                    renderScheduleForm(data); // data es la fecha 'YYYY-MM-DD'
                    break;
                default:
                    renderHome();
            }
        }

        /** Renderiza la vista de Inicio */
        function renderHome() {
            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-6">Selecciona una opción:</h2>
                <div class="space-y-4">
                    <button onclick="setView('calendar')"
                        class="w-full btn-primary text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-3"></i> Ver/Agendar Citas
                    </button>
                    </div>
            `;
        }
        
        /** Renderiza la vista de Calendario Mensual */
        function renderCalendar() {
            const date = currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const firstDayOfMonth = new Date(year, month, 1);
            let startingDay = firstDayOfMonth.getDay(); 
            // 0=Dom, 1=Lun, ..., 6=Sáb. Queremos que Lunes sea 0.
            startingDay = startingDay === 0 ? 6 : startingDay - 1; 

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

            let daysHtml = '';

            // Días de la semana
            daysHtml += dayNames.map(day => `<div class="day-cell day-name text-xs font-bold text-accent">${day}</div>`).join('');

            // Espacios vacíos al inicio
            for (let i = 0; i < startingDay; i++) {
                daysHtml += '<div class="day-cell bg-secondary-dark/50 disabled"></div>';
            }

            // OBTENER FECHAS OCUPADAS: Filtra *solo* las citas del mes que se está viendo
            const occupiedDates = new Set(
                appointments
                    .filter(apt => new Date(apt.dateTime).getMonth() === month && new Date(apt.dateTime).getFullYear() === year)
                    .map(apt => String(new Date(apt.dateTime).getDate()).padStart(2, '0'))
            );
            
            const today = new Date();
            const todayDateOnly = String(today.getDate()).padStart(2, '0');
            const currentMonthYear = `${year}-${String(month + 1).padStart(2, '0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const fullDateString = `${currentMonthYear}-${dayStr}`;
                const isOccupied = occupiedDates.has(dayStr);
                
                // Determinar si el día actual en el calendario es el día de hoy
                const isToday = dayStr === todayDateOnly && today.getMonth() === month && today.getFullYear() === year;

                // Determinar si el día actual en el calendario está en el pasado
                const dayInCalendar = new Date(year, month, day);
                // Restablecer la hora de 'hoy' para comparar solo el día
                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate()); 

                let isPastDay = dayInCalendar < todayMidnight;
                
                let classes = isToday ? 'bg-accent/30 border border-accent text-white' : 'bg-secondary-dark text-gray-300';
                
                // Si es un día pasado, lo atenuamos, pero lo dejamos clicable para ver el historial de citas (si existe)
                if (isPastDay) {
                     classes = 'bg-primary-dark/50 text-gray-500 hover:bg-primary-dark/70';
                     if (isOccupied) {
                          // Si es un día pasado con citas, resaltamos que hay registro
                          classes = 'bg-secondary-dark/80 text-gray-300 border border-occupied-day/50 hover:bg-secondary-dark';
                     }
                }

                daysHtml += `
                    <div class="day-cell ${classes} transition duration-150" 
                         onclick="showDayDetails('${fullDateString}')">
                        <span class="text-sm font-semibold">${day}</span>
                        ${isOccupied ? '<div class="occupied-dot"></div>' : ''}
                    </div>
                `;
            }

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-accent"></i> Calendario de Citas
                </h2>

                <div class="flex justify-between items-center mb-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <button onclick="changeMonth(-1)" class="text-white hover:text-accent transition duration-150 p-2">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h3 class="text-xl font-bold text-white">${monthNames[month]} ${year}</h3>
                    <button onclick="changeMonth(1)" class="text-white hover:text-accent transition duration-150 p-2">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="calendar-grid">
                    ${daysHtml}
                </div>

                <div class="mt-6 flex items-center text-sm text-gray-400 space-x-4">
                    <div class="flex items-center"><div class="occupied-dot mr-2 bg-occupied-day"></div> Cita(s) Agendada(s)</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-accent/30 border border-accent rounded-full mr-2"></div> Hoy</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-primary-dark/50 rounded-full mr-2"></div> Historial/Pasado</div>
                </div>

                <button onclick="setView('home')"
                    class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al Inicio
                </button>
            `;
        }

        function changeMonth(step) {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + step, 1);
            renderCalendar();
        }

        /** Muestra los detalles de un día, incluyendo la opción de agendar o cancelar */
        function showDayDetails(dateStr) {
            // Guarda la fecha actual para usarla al regresar
            const selectedDate = new Date(dateStr);
            const todayMidnight = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            
            // Determina si el día seleccionado es completamente pasado (antes de hoy)
            const isPastDay = selectedDate < todayMidnight; 

            // Citas para este día
            const dayAppointments = appointments
                .filter(apt => formatDateOnly(apt.dateTime) === dateStr)
                .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            let appointmentsHtml = '';
            
            if (dayAppointments.length > 0) {
                appointmentsHtml = dayAppointments.map(apt => {
                    const aptTime = new Date(apt.dateTime);
                    // Determinar si la hora de la cita ya pasó
                    const isPassed = aptTime < new Date(); 
                    
                    // Mostrar la hora en formato 12 horas (ej: 10:30 AM)
                    const timeDisplay = aptTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });

                    let itemClasses = isPassed ? 'bg-red-900/40 text-gray-400 border-red-700/50' : 'bg-green-800/40 text-white border-green-600/50';
                    let statusText = isPassed ? '<span class="text-xs text-red-500">(Pasada)</span>' : '';
                    
                    return `
                        <li class="p-3 rounded-lg flex justify-between items-center ${itemClasses} border">
                            <div>
                                <strong class="text-xl">${timeDisplay}</strong> ${statusText}
                            </div>
                            ${!isPassed ? `<button onclick="confirmCancel(${apt.id})" 
                                class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition duration-150">
                                <i class="fas fa-times-circle mr-1"></i> Cancelar
                            </button>` : ''}
                        </li>
                    `;
                }).join('');
            } else {
                appointmentsHtml = '<p class="text-gray-400 italic">No hay citas agendadas para este día.</p>';
            }

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-accent"></i> Citas para el <span class="text-accent ml-2">${selectedDate.toLocaleDateString('es-ES', { dateStyle: 'full' })}</span>
                </h2>
                
                <h3 class="text-xl font-semibold text-gray-300 mb-3">Detalle de Citas:</h3>
                <ul class="space-y-3 mb-6">
                    ${appointmentsHtml}
                </ul>

                ${!isPastDay ? 
                    `<button onclick="setView('schedule', '${dateStr}')"
                        class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 mb-3">
                        <i class="fas fa-plus-circle mr-2"></i> Agendar Nueva Cita
                    </button>` : 
                    `<p class="p-3 bg-gray-700/50 text-gray-400 rounded-lg text-center"><i class="fas fa-history mr-2"></i> No se pueden agendar citas en días pasados.</p>`
                }
                
                <button onclick="setView('calendar')"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al Calendario
                </button>
            `;
        }

        function confirmCancel(id) {
            showModal(
                'Confirmar Cancelación', 
                '¿Estás seguro de que deseas cancelar esta cita? Esta acción es irreversible.', 
                true, // Es un mensaje de advertencia
                () => cancelAppointment(id) // Callback de confirmación
            );
        }

        /** Renderiza el formulario para agendar una cita */
        function renderScheduleForm(dateStr) {
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i class="fas fa-calendar-plus mr-2 text-accent"></i> Agendar Cita para el <span class="text-accent ml-2">${formattedDate}</span>
                </h2>
                
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label for="timeInput" class="block text-sm font-medium text-gray-300 mb-2">Hora de la Cita:</label>
                        <input type="time" id="timeInput" name="time" required 
                               min="09:00" max="17:00" step="1800" 
                               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-accent focus:border-accent"
                               value="09:00">
                        <p class="text-xs text-gray-400 mt-1">Horario de 9:00 AM a 5:00 PM. Los intervalos son de 30 minutos.</p>
                    </div>

                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300">
                        <i class="fas fa-check-circle mr-2"></i> Confirmar Cita
                    </button>
                </form>

                <button onclick="setView('dayDetails', '${dateStr}')"
                    class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </button>
            `;

            // Manejo del envío del formulario
            document.getElementById('scheduleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const timeInput = document.getElementById('timeInput').value;
                addAppointment(dateStr, timeInput);
            });
        }

        // =======================================================
        // INICIO DE LA APLICACIÓN
        // =======================================================

        function init() {
            appointments = loadAppointments();
            setView('home');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>