<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Citas - Versión con Dictado Implementado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados */
        :root {
            --primary-dark: #1f2937; /* Gray-800 */
            --secondary-dark: #374151; /* Gray-700 */
            --accent: #ef4444; /* Red-500 */
            --occupied-day: #10b981; /* Emerald-500 */
        }
        body {
            background-color: var(--primary-dark);
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .view-container {
            background-color: var(--secondary-dark);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day-cell {
            background-color: var(--secondary-dark);
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            transition: background-color 0.15s;
        }
        .day-name {
            height: 30px;
            background-color: var(--primary-dark);
            color: var(--accent);
            cursor: default;
        }
        .day-cell.disabled {
            cursor: not-allowed;
            background-color: var(--primary-dark);
        }
        .occupied-dot {
            width: 8px;
            height: 8px;
            background-color: var(--occupied-day);
            border-radius: 50%;
            margin-top: 4px;
        }
        .btn-primary {
            background-color: var(--accent);
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .listening-indicator {
            background-color: #f59e0b; /* Amber-500 */
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-6 p-4 bg-secondary-dark rounded-lg">
            <h1 class="text-4xl font-extrabold text-white">Gestor de Citas <i class="fas fa-clock text-accent ml-2"></i></h1>
        </header>
        
        <nav class="flex justify-center space-x-4 mb-6 p-3 bg-gray-800 rounded-lg">
            <button onclick="setView('home')" 
                    class="text-white hover:text-accent font-semibold py-2 px-4 rounded transition duration-200">
                <i class="fas fa-home mr-1"></i> Inicio
            </button>
            <button onclick="setView('calendar')" 
                    class="text-white hover:text-accent font-semibold py-2 px-4 rounded transition duration-200">
                <i class="fas fa-calendar-alt mr-1"></i> Calendario
            </button>
        </nav>

        <div id="viewContainer" class="view-container">
            </div>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center hidden z-50" onclick="hideModal()">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800">Mensaje</h3>
                <p id="modalMessage" class="mb-6 text-gray-600"></p>
                <div id="modalActions" class="flex justify-end space-x-3">
                    <button id="modalCloseButton" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition duration-150">Cerrar</button>
                    </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'appointment_manager_data';
        const HISTORY_MONTHS = 2; // Máximo 2 meses de citas pasadas
        let appointments = [];
        let currentCalendarDate = new Date();
        let currentView = 'home';
        let recognition = null; // Para la API de Voz
        
        const viewContainer = document.getElementById('viewContainer');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');

        // =======================================================
        // UTILIDADES Y FORMATO
        // =======================================================

        function formatDateOnly(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toISOString().substring(0, 10); // YYYY-MM-DD
        }
        
        function formatDateTimeDisplay(dateTimeStr) {
            const date = new Date(dateTimeStr);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
            };
            return date.toLocaleDateString('es-ES', options);
        }

        function showModal(title, message, isError = false, confirmationCallback = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modalActions.innerHTML = '';

            if (confirmationCallback) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-150';
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.onclick = () => {
                    confirmationCallback();
                    hideModal();
                };
                modalActions.appendChild(confirmBtn);
            }
            
            const closeBtn = document.createElement('button');
            closeBtn.id = 'modalCloseButton';
            closeBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition duration-150';
            closeBtn.textContent = confirmationCallback ? 'Cancelar' : 'Cerrar';
            closeBtn.onclick = hideModal;
            modalActions.appendChild(closeBtn);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideModal() {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        // =======================================================
        // GESTIÓN DE LOCALSTORAGE (Corregida)
        // =======================================================

        function saveAppointments(apts) {
            const data = {
                appointments: apts,
                lastSaveTimestamp: Date.now() 
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
                showModal('Error al guardar datos. El almacenamiento podría estar lleno o desactivado.', true);
            }
        }

        /**
         * Carga las citas y limita el historial de citas pasadas a 2 meses.
         */
        function loadAppointments() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (!storedData) {
                    saveAppointments([]);
                    return [];
                }
                
                const data = JSON.parse(storedData);
                let loadedAppointments = data.appointments;
                
                // 1. Determinar el límite de tiempo de retención (2 meses atrás)
                const limitDate = new Date();
                limitDate.setMonth(limitDate.getMonth() - HISTORY_MONTHS);
                limitDate.setHours(0, 0, 0, 0); 
                
                // 2. Filtrar y mantener solo las citas que son FUTURAS o dentro del límite de 2 meses
                const validAppointments = loadedAppointments.filter(apt => {
                    const aptDate = new Date(apt.dateTime);
                    return aptDate >= limitDate;
                });
                
                // 3. Si se eliminaron citas, guardamos el nuevo array para persistir la limpieza
                if (validAppointments.length !== loadedAppointments.length) {
                    console.log(`Se eliminaron ${loadedAppointments.length - validAppointments.length} citas que superaron el límite de ${HISTORY_MONTHS} meses de historial.`);
                    saveAppointments(validAppointments);
                }
                
                return validAppointments.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            } catch (error) {
                console.error('Error al cargar o analizar localStorage:', error);
                showModal('Error al cargar datos. Los datos de citas podrían estar corruptos.', true);
                return [];
            }
        }

        // =======================================================
        // LÓGICA DE CITAS Y VALIDACIÓN (Corregida)
        // =======================================================

        /** Agrega una cita y valida disponibilidad. */
        function addAppointment(dateStr, timeStr) {
            const [hourStr, minuteStr] = timeStr.split(':');
            let hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);
            
            // CORRECCIÓN ZONA HORARIA: Usar constructor de fecha local (year, month, day, hour, minute)
            const [year, month, day] = dateStr.split('-').map(Number);
            const newAppointmentDate = new Date(year, month - 1, day, hour, minute, 0, 0);
            
            const now = new Date();
            
            // Validación 1: No agendar en el pasado
            if (newAppointmentDate <= now) {
                showModal('Error al Agendar', 'No se puede agendar una cita en el pasado o a una hora ya transcurrida.', true);
                return false; // Devuelve false para indicar fallo
            }

            // Validación 2: Chequear disponibilidad (30 minutos)
            const isAvailable = appointments.every(apt => {
                const existingDate = new Date(apt.dateTime);
                const diff = Math.abs(newAppointmentDate.getTime() - existingDate.getTime());
                return diff >= (30 * 60 * 1000); 
            });

            if (!isAvailable) {
                showModal('Error al Agendar', 'Ya existe una cita muy cercana a esta hora. Intervalo mínimo de 30 minutos.', true);
                return false; // Devuelve false para indicar fallo
            }

            // Agendar la cita
            const newAppointment = {
                id: Date.now(), 
                dateTime: newAppointmentDate.toISOString(), 
            };

            appointments.push(newAppointment);
            saveAppointments(appointments);
            
            showModal('Cita Agendada', `Tu cita ha sido agendada para el ${formatDateTimeDisplay(newAppointment.dateTime)}.`, false);
            
            return true; // Devuelve true para indicar éxito
        }

        function cancelAppointment(id) {
            const appointmentId = Number(id); 
            const originalLength = appointments.length;
            appointments = appointments.filter(apt => apt.id !== appointmentId);
            
            if (appointments.length < originalLength) {
                saveAppointments(appointments);
                showModal('Cita Cancelada', 'La cita ha sido cancelada exitosamente.', false);
                setView('calendar'); 
            } else {
                showModal('Error al Cancelar', 'No se encontró la cita a cancelar.', true);
            }
        }

        // =======================================================
        // IMPLEMENTACIÓN DE RECONOCIMIENTO DE VOZ
        // =======================================================

        function scheduleWithVoice() {
            // Comprobación de compatibilidad
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showModal('Error de Compatibilidad', 'Tu navegador no soporta la API de Reconocimiento de Voz. Usa Chrome o Edge.', true);
                return;
            }
            
            setView('voiceSchedule');
        }

        function startVoiceRecognition() {
            // Detiene cualquier reconocimiento anterior
            if (recognition) {
                recognition.stop();
            }

            // Define el objeto de reconocimiento para Webkit (Chrome/Edge)
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.lang = 'es-ES'; // Establece el idioma a Español
            recognition.interimResults = false; // Solo devuelve resultados finales
            recognition.maxAlternatives = 1;

            const voiceOutput = document.getElementById('voiceOutput');
            const voiceStatus = document.getElementById('voiceStatus');
            const micIcon = document.getElementById('micIcon');
            
            if (!micIcon || !voiceStatus) return;

            micIcon.classList.add('listening-indicator');
            micIcon.classList.remove('text-gray-500');
            micIcon.classList.add('text-white');
            voiceStatus.textContent = 'Escuchando... Di: "Cita el [día/fecha] a las [hora]".';

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const command = event.results[last][0].transcript;
                voiceOutput.textContent = `Comando reconocido: "${command}"`;
                processVoiceCommand(command);
            };

            recognition.onerror = (event) => {
                micIcon.classList.remove('listening-indicator', 'text-white');
                micIcon.classList.add('text-gray-500');
                voiceStatus.textContent = `Error: ${event.error}. Inténtalo de nuevo.`;
                console.error('Speech Recognition Error:', event.error);
                if (event.error !== 'no-speech') {
                    showModal('Error de Dictado', `Hubo un error en el reconocimiento de voz: ${event.error}. Asegúrate de conceder permisos al micrófono.`, true);
                }
            };

            recognition.onend = () => {
                micIcon.classList.remove('listening-indicator', 'text-white');
                micIcon.classList.add('text-gray-500');
                if (voiceStatus.textContent === 'Escuchando... Di: "Cita el [día/fecha] a las [hora]".') {
                    voiceStatus.textContent = 'Reconocimiento finalizado. Inténtalo de nuevo.';
                }
            };

            recognition.start();
        }

        function processVoiceCommand(command) {
            // Ejemplo de comando: "Cita el 15 de Octubre a las 10 y media" o "Cita el Lunes a las 9"
            command = command.toLowerCase().trim();
            const today = new Date();
            let dateStr = null;
            let timeStr = null;

            // 1. EXTRAER LA FECHA
            
            // Intento 1: Días de la semana (Lunes, Martes, etc.)
            const daysOfWeek = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
            const dayMatch = daysOfWeek.find(d => command.includes(d));

            if (dayMatch) {
                const targetDayIndex = daysOfWeek.indexOf(dayMatch);
                let targetDate = new Date(today);
                // Calcula el próximo día de la semana
                targetDate.setDate(today.getDate() + (targetDayIndex + 7 - today.getDay()) % 7);
                // Si el día de la semana es hoy o ya pasó, agendamos para la próxima semana
                if (targetDate <= today) {
                    targetDate.setDate(targetDate.getDate() + 7);
                }
                dateStr = targetDate.toISOString().substring(0, 10);
            } 
            
            // Intento 2: Fechas absolutas (el 15 de octubre)
            const dateRegex = /(\d{1,2}) de (\w+)/;
            const dateParts = command.match(dateRegex);

            if (dateParts) {
                const day = parseInt(dateParts[1]);
                const monthName = dateParts[2].toLowerCase();
                const monthNamesEs = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                const monthIndex = monthNamesEs.indexOf(monthName);
                
                if (monthIndex !== -1) {
                    const targetDate = new Date(today.getFullYear(), monthIndex, day);
                    // Si la fecha es pasada, asumimos el próximo año
                    if (targetDate < today) {
                        targetDate.setFullYear(today.getFullYear() + 1);
                    }
                    dateStr = targetDate.toISOString().substring(0, 10);
                }
            }


            // 2. EXTRAER LA HORA
            const timeRegex = /(\d{1,2})(?: y media| y cuarto)?/i;
            const timeParts = command.match(timeRegex);

            if (timeParts) {
                let hour = parseInt(timeParts[1]);
                let minute = 0;
                
                // Normalización de frases comunes
                if (command.includes('y media')) {
                    minute = 30;
                } else if (command.includes('y cuarto')) {
                    minute = 15;
                    // Forzamos el ajuste a 30 minutos (regla de la app)
                    minute = 30; 
                }

                // Ajuste AM/PM (muy básico, asume horario laboral 9-17)
                if (hour < 9) hour += 12; // Si dice 5, asume 5 PM (17:00)

                timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            }

            // 3. AGENDAR
            if (dateStr && timeStr) {
                if (addAppointment(dateStr, timeStr)) {
                    // Si la cita fue exitosa, el modal de confirmación se encargará de notificar.
                    setView('calendar');
                } else {
                    // Si la cita falló (pasado o duplicado), addAppointment ya mostró un modal.
                    setView('voiceSchedule'); // Permite otro intento de dictado
                }
            } else {
                showModal('Error de Comando', 'No pude entender la fecha y hora. Usa el formato: "Cita el [día/fecha] a las [hora]". Ejemplo: "Cita el lunes a las 10:30".', true);
                setView('voiceSchedule'); // Permite otro intento
            }
        }


        // =======================================================
        // VISTAS Y RENDERIZADO
        // =======================================================

        function setView(viewName, data = null) {
            currentView = viewName;
            // Detener el reconocimiento si cambiamos de vista
            if (recognition && viewName !== 'voiceSchedule') {
                recognition.stop();
            }

            switch (viewName) {
                case 'home':
                    renderHome();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'dayDetails':
                    showDayDetails(data); 
                    break;
                case 'schedule':
                    renderScheduleForm(data); 
                    break;
                case 'voiceSchedule':
                    renderVoiceSchedule();
                    break;
                default:
                    renderHome();
            }
        }

        function renderHome() {
            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-6">Selecciona una opción:</h2>
                <div class="space-y-4">
                    <button onclick="scheduleWithVoice()"
                        class="w-full btn-primary text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-microphone-alt mr-3"></i> Agendar Cita con Dictado
                    </button>
                    <button onclick="viewAppointments()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center transition duration-300">
                        <i class="fas fa-eye mr-3"></i> Ver Citas
                    </button>
                    <button onclick="deleteAppointments()"
                        class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center transition duration-300">
                        <i class="fas fa-trash-alt mr-3"></i> Borrar Citas (Todas)
                    </button>
                </div>
                <p class="text-gray-400 text-sm mt-6 text-center">Para agendar manualmente, usa la opción "Ver Citas" e ingresa al Calendario.</p>
            `;
        }

        function renderVoiceSchedule() {
            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i class="fas fa-microphone-alt mr-2 text-accent"></i> Agendar por Voz
                </h2>
                
                <div class="text-center p-6 bg-gray-700 rounded-lg shadow-md">
                    <i id="micIcon" class="fas fa-microphone text-gray-500 text-6xl mb-4 transition duration-300"></i>
                    <p id="voiceStatus" class="text-gray-300 text-lg font-semibold mb-4">Pulsa el botón para comenzar a dictar.</p>
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg">
                        <p class="text-sm text-gray-400">Comando Sugerido:</p>
                        <p class="text-white font-mono text-base">"Cita el [Día/Fecha] a las [Hora]"</p>
                    </div>
                    <button onclick="startVoiceRecognition()"
                        class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 mb-4">
                        <i class="fas fa-play mr-2"></i> Iniciar Dictado
                    </button>
                    <p id="voiceOutput" class="text-gray-400 italic text-sm mt-3 h-6">Esperando comando...</p>
                </div>
                
                <button onclick="setView('home')"
                    class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al Inicio
                </button>
            `;
        }
        
        function viewAppointments() {
            setView('calendar');
        }

        function deleteAppointments() {
            showModal(
                'Borrar TODAS las Citas', 
                '¿Estás seguro de que quieres borrar **TODAS** las citas agendadas? Esta acción es irreversible.', 
                true, 
                () => {
                    appointments = []; 
                    saveAppointments([]); 
                    showModal('Éxito', 'Todas las citas han sido borradas exitosamente.', false);
                    setView('home');
                }
            );
        }

        // Resto de las funciones de renderizado (renderCalendar, showDayDetails, renderScheduleForm, etc.) 
        // permanecen igual que en la versión anterior.
        
        function renderCalendar() {
            const date = currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const firstDayOfMonth = new Date(year, month, 1);
            let startingDay = firstDayOfMonth.getDay(); 
            startingDay = startingDay === 0 ? 6 : startingDay - 1; 

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

            let daysHtml = '';

            daysHtml += dayNames.map(day => `<div class="day-cell day-name text-xs font-bold text-accent">${day}</div>`).join('');

            for (let i = 0; i < startingDay; i++) {
                daysHtml += '<div class="day-cell bg-secondary-dark/50 disabled"></div>';
            }

            const occupiedDates = new Set(
                appointments
                    .filter(apt => new Date(apt.dateTime).getMonth() === month && new Date(apt.dateTime).getFullYear() === year)
                    .map(apt => String(new Date(apt.dateTime).getDate()).padStart(2, '0'))
            );
            
            const today = new Date();
            const todayDateOnly = String(today.getDate()).padStart(2, '0');
            const currentMonthYear = `${year}-${String(month + 1).padStart(2, '0')}`;
            const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate()); 

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const fullDateString = `${currentMonthYear}-${dayStr}`;
                const isOccupied = occupiedDates.has(dayStr);
                const isToday = dayStr === todayDateOnly && today.getMonth() === month && today.getFullYear() === year;

                const dayInCalendar = new Date(year, month, day);
                let isPastDay = dayInCalendar < todayMidnight;
                
                let classes = isToday ? 'bg-accent/30 border border-accent text-white' : 'bg-secondary-dark text-gray-300';
                
                if (isPastDay) {
                     classes = 'bg-primary-dark/50 text-gray-500 hover:bg-primary-dark/70';
                     if (isOccupied) {
                          classes = 'bg-secondary-dark/80 text-gray-300 border border-occupied-day/50 hover:bg-secondary-dark';
                     }
                }

                daysHtml += `
                    <div class="day-cell ${classes} transition duration-150" 
                         onclick="showDayDetails('${fullDateString}')">
                        <span class="text-sm font-semibold">${day}</span>
                        ${isOccupied ? '<div class="occupied-dot"></div>' : ''}
                    </div>
                `;
            }

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-accent"></i> Calendario de Citas
                </h2>

                <div class="flex justify-between items-center mb-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <button onclick="changeMonth(-1)" class="text-white hover:text-accent transition duration-150 p-2">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h3 class="text-xl font-bold text-white">${monthNames[month]} ${year}</h3>
                    <button onclick="changeMonth(1)" class="text-white hover:text-accent transition duration-150 p-2">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="calendar-grid">
                    ${daysHtml}
                </div>

                <div class="mt-6 flex items-center text-sm text-gray-400 space-x-4">
                    <div class="flex items-center"><div class="occupied-dot mr-2 bg-occupied-day"></div> Cita(s) Agendada(s)</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-accent/30 border border-accent rounded-full mr-2"></div> Hoy</div>
                    <div class="flex items-center"><div class="w-3 h-3 bg-primary-dark/50 rounded-full mr-2"></div> Historial (Pasado)</div>
                </div>

                <button onclick="setView('home')"
                    class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al Inicio
                </button>
            `;
        }

        function changeMonth(step) {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + step, 1);
            renderCalendar();
        }

        function showDayDetails(dateStr) {
            const selectedDate = new Date(dateStr);
            const todayMidnight = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            const isPastDay = selectedDate < todayMidnight; 

            const dayAppointments = appointments
                .filter(apt => formatDateOnly(apt.dateTime) === dateStr)
                .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            let appointmentsHtml = '';
            
            if (dayAppointments.length > 0) {
                appointmentsHtml = dayAppointments.map(apt => {
                    const aptTime = new Date(apt.dateTime);
                    const isPassed = aptTime < new Date(); 
                    
                    const timeDisplay = aptTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });

                    let itemClasses = isPassed ? 'bg-red-900/40 text-gray-400 border-red-700/50' : 'bg-green-800/40 text-white border-green-600/50';
                    let statusText = isPassed ? '<span class="text-xs text-red-500">(Pasada)</span>' : '';
                    
                    return `
                        <li class="p-3 rounded-lg flex justify-between items-center ${itemClasses} border">
                            <div>
                                <strong class="text-xl">${timeDisplay}</strong> ${statusText}
                            </div>
                            ${!isPassed ? `<button onclick="confirmCancel(${apt.id})" 
                                class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition duration-150">
                                <i class="fas fa-times-circle mr-1"></i> Cancelar
                            </button>` : ''}
                        </li>
                    `;
                }).join('');
            } else {
                appointmentsHtml = '<p class="text-gray-400 italic">No hay citas agendadas para este día.</p>';
            }

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-accent"></i> Citas para el <span class="text-accent ml-2">${selectedDate.toLocaleDateString('es-ES', { dateStyle: 'full' })}</span>
                </h2>
                
                <h3 class="text-xl font-semibold text-gray-300 mb-3">Detalle de Citas:</h3>
                <ul class="space-y-3 mb-6">
                    ${appointmentsHtml}
                </ul>

                ${!isPastDay ? 
                    `<button onclick="setView('schedule', '${dateStr}')"
                        class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 mb-3">
                        <i class="fas fa-plus-circle mr-2"></i> Agendar Nueva Cita
                    </button>` : 
                    `<p class="p-3 bg-gray-700/50 text-gray-400 rounded-lg text-center"><i class="fas fa-history mr-2"></i> Solo se pueden ver citas pasadas, no agendar.</p>`
                }
                
                <button onclick="setView('calendar')"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al Calendario
                </button>
            `;
        }

        function confirmCancel(id) {
            showModal(
                'Confirmar Cancelación', 
                '¿Estás seguro de que deseas cancelar esta cita? Esta acción es irreversible.', 
                true, 
                () => cancelAppointment(id) 
            );
        }

        function renderScheduleForm(dateStr) {
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i class="fas fa-calendar-plus mr-2 text-accent"></i> Agendar Cita para el <span class="text-accent ml-2">${formattedDate}</span>
                </h2>
                
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label for="timeInput" class="block text-sm font-medium text-gray-300 mb-2">Hora de la Cita:</label>
                        <input type="time" id="timeInput" name="time" required 
                               min="09:00" max="17:00" step="1800" 
                               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-accent focus:border-accent"
                               value="09:00">
                        <p class="text-xs text-gray-400 mt-1">Horario de 9:00 AM a 5:00 PM. Los intervalos son de 30 minutos.</p>
                    </div>

                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300">
                        <i class="fas fa-check-circle mr-2"></i> Confirmar Cita
                    </button>
                </form>

                <button onclick="setView('dayDetails', '${dateStr}')"
                    class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </button>
            `;

            document.getElementById('scheduleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const timeInput = document.getElementById('timeInput').value;
                addAppointment(dateStr, timeInput);
            });
        }


        // =======================================================
        // INICIO DE LA APLICACIÓN
        // =======================================================

        function init() {
            appointments = loadAppointments();
            setView('home');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>