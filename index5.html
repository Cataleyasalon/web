<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Cataleya - Sistema de Citas (v2.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827', // Gray-900
                        'secondary-dark': '#1f2937', // Gray-800
                        'accent': '#a78bfa', // Violet-400
                        'accent-hover': '#8b5cf6', // Violet-500
                        'cancel': '#f87171', // Red-400
                        'occupied-day': '#8b5cf6', // Violet-500 para d√≠as ocupados
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilo general oscuro y minimalista */
        body {
            background-color: #0d1117; /* Fondo muy oscuro */
            color: #d1d5db; /* Texto gris claro */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; 
        }

        .card {
            background-color: #161b22; /* Fondo de tarjeta m√°s claro que el body */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        /* Estilo para la lista de citas */
        .appointment-item:hover {
            background-color: #2d3748;
        }
        
        /* Estilo minimalista para scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; /* Gray-600 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; /* Gray-800 */
        }
        
        /* Estilos del calendario */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day-cell {
            padding: 5px;
            height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .day-cell:hover:not(.day-name):not(.disabled) {
            background-color: #1f2937;
        }
        .occupied-dot {
            height: 6px;
            width: 6px;
            background-color: #a78bfa; /* accent */
            border-radius: 50%;
            margin-top: 2px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div id="app" class="card p-6 sm:p-8 lg:p-10 w-full max-w-lg mx-4 rounded-xl transition-all duration-300">

        <div id="logo-image-container" class="text-center mb-6">
            <img src="https://cataleyasalon.github.io/web/cabecera.png" 
                alt="Logo de la Aplicaci√≥n"> 
        </div>
        
        <div id="view-container">
            </div>

        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-secondary-dark p-6 rounded-lg max-w-sm w-full text-center border border-accent">
                <div id="modal-icon-container" class="text-3xl mb-3 text-red-500"></div>
                <p id="modal-text" class="text-white text-lg mb-4"></p>
                <button onclick="closeModal()" class="bg-accent hover:bg-accent-hover text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md shadow-violet-700/50">
                    Entendido
                </button>
            </div>
        </div>

        <div id="reminder-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
            <div class="bg-secondary-dark p-6 rounded-xl max-w-sm w-full text-left border border-accent shadow-2xl shadow-violet-700/50 transform transition-all duration-300 scale-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="reminder-title" class="text-xl font-bold text-accent"></h3>
                    <button onclick="closeReminderModal()" class="text-gray-400 hover:text-white transition duration-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="reminder-content" class="text-gray-300 space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                    </div>
                <button onclick="closeReminderModal()" class="mt-4 w-full bg-accent hover:bg-accent-hover text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cerrar
                </button>
            </div>
        </div>

    </div>

    <script>
        // =======================================================
        // CONSTANTES Y CONFIGURACI√ìN
        // =======================================================
        const STORAGE_KEY = 'cataleya_appointments_data';
        let currentView = 'home';
        let appointments = [];
        let recognition = null; 
        let currentCalendarDate = new Date(); 

        const viewContainer = document.getElementById('view-container');
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalIconContainer = document.getElementById('modal-icon-container');

        // =======================================================
        // UTILER√çAS GLOBALES
        // =======================================================

        /** Muestra un modal personalizado con o sin icono de error. */
        function showModal(message, isError = false) {
            if (isError) {
                playErrorSound();
                modalIconContainer.innerHTML = '<i class="fas fa-ban"></i>'; // Icono de Prohibido
            } else {
                playNotificationSound(); 
                modalIconContainer.innerHTML = ''; // Sin icono para √©xito/informaci√≥n
            }
            modalText.textContent = message;
            messageModal.classList.remove('hidden');
        }

        /** Cierra el modal personalizado */
        function closeModal() {
            messageModal.classList.add('hidden');
        }

        /** Reproduce un sonido de notificaci√≥n simple (beep) usando Web Audio API. */
        function playNotificationSound(frequency = 440, duration = 0.2) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.01);

                oscillator.start();
                
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (e) {
                console.warn('Fallo al reproducir sonido:', e);
            }
        }
        
        /** Reproduce un sonido de error (m√°s √°spero) */
        function playErrorSound() {
            // Sonido de doble 'beep'
            playNotificationSound(300, 0.1); 
            setTimeout(() => playNotificationSound(250, 0.15), 150);
        }

        /** Muestra el modal de recordatorio diario o detalles del d√≠a. */
        function showDailyReminderModal(title, htmlContent) {
            playNotificationSound(880, 0.5); 
            document.getElementById('reminder-title').textContent = title;
            document.getElementById('reminder-content').innerHTML = htmlContent;
            document.getElementById('reminder-modal').classList.remove('hidden');
        }

        /** Cierra el modal de recordatorio diario. */
        function closeReminderModal() {
            document.getElementById('reminder-modal').classList.add('hidden');
        }

        /** Formatea una fecha y hora como 'DD/MM/YYYY HH:mm' */
        function formatDateTime(date) {
            const d = new Date(date);
            const dateStr = d.toLocaleDateString('es-ES', {
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
            const timeStr = d.toLocaleTimeString('es-ES', {
                hour: '2-digit', minute: '2-digit'
            });
            return `${dateStr} a las ${timeStr}`;
        }

        /** Formatea una fecha solo como 'YYYY-MM-DD' para comparaci√≥n */
        function formatDateOnly(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // =======================================================
        // GESTI√ìN DE LOCALSTORAGE
        // =======================================================

        function saveAppointments(apts, timestamp = Date.now()) {
            const data = {
                appointments: apts,
                lastResetTimestamp: timestamp
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
                showModal('Error al guardar datos. El almacenamiento podr√≠a estar lleno o desactivado.', true);
            }
        }

        function loadAppointments() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    const lastDate = new Date(data.lastResetTimestamp);
                    const now = new Date();

                    if (now.getFullYear() > lastDate.getFullYear() || now.getMonth() > lastDate.getMonth()) {
                        console.log('¬°Nuevo mes detectado! Reiniciando la base de datos de citas.');
                        saveAppointments([], now.getTime());
                        return []; 
                    }
                    return data.appointments.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                } else {
                    saveAppointments([], Date.now());
                    return [];
                }
            } catch (error) {
                console.error('Error al cargar o analizar localStorage:', error);
                showModal('Error al cargar datos. Los datos de citas podr√≠an estar corruptos.', true);
                return [];
            }
        }

        // =======================================================
        // VISTAS Y RENDERIZADO
        // =======================================================

        /** Rota la vista de la aplicaci√≥n. */
        function setView(viewName, date = null) {
            currentView = viewName;
            if (viewName === 'calendar' && date) {
                currentCalendarDate = new Date(date);
            }
            renderView();
        }

        /** Renderiza la vista principal (Home) */
        function renderHome() {
            viewContainer.innerHTML = `
                <div class="space-y-4">
                    <button onclick="startSpeechRecognition()"
                        class="w-full bg-accent hover:bg-accent-hover text-white text-lg font-extrabold py-4 px-6 rounded-xl transition duration-300 transform hover:scale-[1.02] shadow-xl shadow-violet-700/30 flex items-center justify-center">
                        <i class="fas fa-microphone text-2xl mr-3"></i>
                        AGENDAR CITA (DICTADO)
                    </button>

                    <button onclick="setView('calendar')"
                        class="w-full bg-secondary-dark hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center border border-gray-700">
                        <i class="fas fa-calendar-alt mr-3"></i>
                        VER CALENDARIO
                    </button>

                    <button onclick="setView('cancel')"
                        class="w-full bg-cancel hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center border border-red-600">
                        <i class="fas fa-times-circle mr-3"></i>
                        CANCELAR CITA
                    </button>
                </div>
            `;
        }
        
        /** Muestra el detalle de citas para un d√≠a espec√≠fico */
        function showDayDetails(dateString) {
            const dayAppointments = appointments.filter(apt => apt.dateTime.startsWith(dateString));
            const dateDisplay = new Date(dateString).toLocaleDateString('es-ES', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            
            // Icono de Cita Agendada: calendar-check
            const appointmentIcon = '<i class="fas fa-calendar-check text-accent mr-2"></i>';

            let content;
            if (dayAppointments.length > 0) {
                content = dayAppointments.map(apt => {
                    // *** CAMBIO CLAVE AQU√ç: SOLO SE MUESTRA EL NOMBRE Y LA HORA ***
                    const timeOnly = formatDateTime(apt.dateTime).split(' a las ')[1];
                    return `
                        <div class="border-l-4 border-accent pl-3 py-2 bg-gray-800 rounded-lg flex items-center">
                            <span class="text-sm text-gray-400 mr-2">${appointmentIcon}</span>
                            <div>
                                <p class="font-semibold text-white text-base">${apt.name}</p>
                                <p class="text-sm text-gray-400">Hora: ${timeOnly}</p>
                            </div>
                        </div>
                    `;
                }).join('<div class="h-3"></div>');
            } else {
                content = `<p class="text-gray-500 text-center py-4">No hay citas para este d√≠a.</p>`;
            }

            // T√≠tulo modificado a "Citas Agendadas"
            showDailyReminderModal(`Citas Agendadas del ${dateDisplay.charAt(0).toUpperCase() + dateDisplay.slice(1)}`, content);
        }


        /** Renderiza la vista de Calendario Mensual */
        function renderCalendar() {
            const date = currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const firstDayOfMonth = new Date(year, month, 1);
            let startingDay = firstDayOfMonth.getDay(); 
            startingDay = startingDay === 0 ? 6 : startingDay - 1; 

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const dayNames = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];

            let daysHtml = '';

            // D√≠as de la semana
            daysHtml += dayNames.map(day => `<div class="day-cell day-name text-xs font-bold text-accent">${day}</div>`).join('');

            // Espacios vac√≠os al inicio
            for (let i = 0; i < startingDay; i++) {
                daysHtml += '<div class="day-cell bg-secondary-dark/50 disabled"></div>';
            }

            // D√≠as del mes
            const occupiedDates = new Set(appointments.map(apt => formatDateOnly(apt.dateTime).substring(8, 10)));
            const todayDateOnly = formatDateOnly(new Date()).substring(8, 10);
            const currentMonthYear = `${year}-${String(month + 1).padStart(2, '0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const fullDateString = `${currentMonthYear}-${dayStr}`;
                const isOccupied = occupiedDates.has(dayStr);
                const isToday = dayStr === todayDateOnly && new Date().getMonth() === month && new Date().getFullYear() === year;
                
                let classes = isToday ? 'bg-accent/30 border border-accent text-white' : 'bg-secondary-dark text-gray-300';
                
                daysHtml += `
                    <div class="day-cell ${classes} hover:bg-secondary-dark/80 transition duration-150" 
                         onclick="showDayDetails('${fullDateString}')">
                        <span class="text-sm font-semibold">${day}</span>
                        ${isOccupied ? '<div class="occupied-dot"></div>' : ''}
                    </div>
                `;
            }


            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-accent"></i> Calendario Mensual
                </h2>

                <div class="flex justify-between items-center mb-4 bg-secondary-dark p-3 rounded-lg border border-gray-700">
                    <button onclick="changeMonth(-1)" class="text-white hover:text-accent transition duration-150 p-2">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h3 class="text-xl font-bold text-white">${monthNames[month]} ${year}</h3>
                    <button onclick="changeMonth(1)" class="text-white hover:text-accent transition duration-150 p-2">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="calendar-grid">
                    ${daysHtml}
                </div>

                <div class="mt-6 flex items-center text-sm text-gray-400">
                    <div class="occupied-dot mr-2"></div> Cita(s) agendada(s)
                </div>

                <button onclick="setView('home')"
                    class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver al Inicio
                </button>
            `;
        }

        /** Cambia el mes del calendario y lo re-renderiza */
        function changeMonth(delta) {
            const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + delta, 1);
            setView('calendar', newDate);
        }

        /** Renderiza la vista de Cancelar Cita */
        function renderCancel() {
            const hasAppointments = appointments.length > 0;
            const content = hasAppointments 
                ? appointments.map(apt => `
                    <div class="appointment-item p-4 mb-2 bg-secondary-dark rounded-lg flex justify-between items-center transition duration-150 border border-gray-700" id="apt-${apt.id}">
                        <div>
                            <p class="text-accent font-bold">${apt.name}</p>
                            <p class="text-sm text-gray-400">${formatDateTime(apt.dateTime)}</p>
                        </div>
                        <button onclick="confirmCancelAppointment('${apt.id}')"
                            class="text-cancel hover:text-red-300 font-bold py-1 px-3 rounded-lg transition duration-200 border border-cancel hover:border-red-300">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('')
                : `<p class="text-center text-gray-500 py-8">No hay citas para cancelar.</p>`;

            viewContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-trash-alt mr-2 text-cancel"></i> Cancelar Citas
                </h2>
                <div class="max-h-80 overflow-y-auto custom-scrollbar pr-2">
                    ${content}
                </div>
                <button onclick="setView('home')"
                    class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </button>
            `;
        }

        /** Funci√≥n principal de renderizado */
        function renderView() {
            appointments = loadAppointments(); 
            if (recognition) {
                recognition.stop(); 
            }
            switch (currentView) {
                case 'calendar':
                    renderCalendar();
                    break;
                case 'cancel':
                    renderCancel();
                    break;
                case 'home':
                default:
                    renderHome();
                    break;
            }
        }

        // =======================================================
        // GESTI√ìN DE CITAS Y CONFLICTOS
        // =======================================================

        /** Verifica si una fecha y hora espec√≠fica ya tiene una cita */
        function isTimeSlotOccupied(dateString) {
            const newTime = new Date(dateString).getTime();
            
            // Verifica si la nueva hora coincide exactamente con alguna existente (precisi√≥n al minuto)
            const isConflict = appointments.some(apt => {
                return new Date(apt.dateTime).getTime() === newTime;
            });

            return isConflict;
        }

        /** Agrega una nueva cita. */
        function addAppointment(name, dateString) {
            if (new Date(dateString) < Date.now()) {
                showModal('¬°Error! No puedes agendar una cita en el pasado.', true);
                return;
            }

            if (isTimeSlotOccupied(dateString)) {
                // Alerta sonora y pop-up con icono de prohibido
                showModal(`¬°ALERTA! La hora y fecha: ${formatDateTime(dateString)} ya est√°n reservadas. Por favor, elige otro horario.`, true);
                return;
            }

            const newAppointment = {
                id: crypto.randomUUID(),
                name: name.trim(),
                dateTime: new Date(dateString).toISOString()
            };

            appointments.push(newAppointment);
            saveAppointments(appointments);
            
            // Mensaje de √©xito (no es error, por lo que isError=false)
            showModal(`¬°Cita agendada con √©xito! ${name} el ${formatDateTime(newAppointment.dateTime)}.`);
            
            setView('home'); 
        }

        /** Confirma y ejecuta la cancelaci√≥n de una cita. */
        function confirmCancelAppointment(id) {
            
            const aptToCancel = appointments.find(apt => apt.id === id);

            if (!aptToCancel) {
                 showModal('Error: Cita no encontrada.', true);
                 renderCancel();
                 return;
            }
            
            const confirmed = true; 
            
            if (confirmed) {
                appointments = appointments.filter(apt => apt.id !== id);
                saveAppointments(appointments);
                showModal(`La cita de ${aptToCancel.name} ha sido cancelada.`);
                renderCancel(); 
            }
        }

        // =======================================================
        // RECONOCIMIENTO DE VOZ (Dictado)
        // =======================================================

        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showModal('Tu navegador no soporta la funci√≥n de dictado.', true);
                return;
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            viewContainer.innerHTML = `
                <div class="text-center p-6 bg-secondary-dark rounded-lg border border-accent">
                    <p class="text-xl font-semibold text-white mb-4">Escuchando...</p>
                    <i class="fas fa-microphone-alt animate-pulse text-5xl text-accent mb-4"></i>
                    <p class="text-gray-400">Di el nombre y la hora de la cita, por ejemplo:</p>
                    <p class="text-sm font-mono text-gray-500">"Agendar a Juan P√©rez el 10 de octubre a las 3 de la tarde"</p>
                    <button onclick="setView('home')"
                        class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        <i class="fas fa-stop mr-2"></i> Cancelar Dictado
                    </button>
                </div>
            `;

            recognition.onresult = (event) => {
                recognition.stop();
                const transcript = event.results[0][0].transcript;
                processVoiceCommand(transcript);
            };

            recognition.onerror = (event) => {
                recognition.stop();
                if (event.error !== 'not-allowed') {
                    showModal(`Error de dictado: ${event.error === 'no-speech' ? 'No se detect√≥ voz.' : 'Ocurri√≥ un error.'}`, true);
                } else {
                    showModal('Acceso al micr√≥fono denegado.', true);
                }
                setView('home');
            };

            recognition.onend = () => {
                if (viewContainer.querySelector('.animate-pulse')) {
                    setView('home');
                }
            };

            try {
                recognition.start();
            } catch (e) {
                showModal("Error al iniciar el reconocimiento de voz.", true);
                setView('home');
            }
        }

        /** Procesa el texto reconocido para extraer nombre y fecha/hora. */
        function processVoiceCommand(text) {
            const lowerText = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '');
            
            const dateRegex = /(\d{1,2})\s+(?:de|del)?\s*(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)(?:.*?)\s*(\d{1,2})(:\d{2})?\s+(de la ma√±ana|de la tarde|pm|am)/i;
            
            const match = lowerText.match(dateRegex);

            if (!match) {
                showModal(`No pude encontrar una fecha y hora clara en: "${text}". Por favor, intenta de nuevo (Ej: "Agendar a Juan P√©rez el 10 de octubre a las 3 de la tarde").`, true);
                setView('home');
                return;
            }
            
            const commandStart = lowerText.indexOf('agendar');
            const nameEnd = match.index;

            let name = 'Cliente Dictado';
            if (commandStart !== -1 && nameEnd > commandStart) {
                let rawName = text.substring(commandStart, nameEnd).trim();
                name = rawName.replace(/agendar\s*(a|una cita a|para)\s*/i, '').trim();
                if (name === '') name = 'Cliente Dictado';
            }
            
            const day = match[1];
            const rawMonth = match[2];
            let hour = parseInt(match[3], 10);
            const minutes = match[4] ? match[4].substring(1) : '00';
            const rawMarker = match[5];
            const currentYear = new Date().getFullYear();

            const monthIndexMap = {
                'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3,
                'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7,
                'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
            };
            const monthIndex = monthIndexMap[rawMonth];
            
            const isPM = rawMarker.includes('tarde') || rawMarker.includes('pm');
            const isAM = rawMarker.includes('ma√±ana') || rawMarker.includes('am');

            if (isPM) {
                if (hour < 12) {
                    hour += 12;
                }
            } else if (isAM) {
                if (hour === 12) {
                    hour = 0;
                }
            }
            
            const yearNum = currentYear;
            const dayNum = parseInt(day, 10);
            const hourNum = hour;
            const minuteNum = parseInt(minutes, 10);
            
            const aptDate = new Date(yearNum, monthIndex, dayNum, hourNum, minuteNum, 0);

            if (isNaN(aptDate.getTime()) || aptDate.getMonth() !== monthIndex || aptDate.getDate() !== dayNum) {
                showModal(`Error (Fecha Inv√°lida): No pude crear una fecha v√°lida.`, true);
                setView('home');
                return;
            }
            
            addAppointment(name, aptDate.toISOString());
        }

        // =======================================================
        // GESTI√ìN DE RECORDATORIO DIARIO (10:00 PM)
        // =======================================================
        
        /** Obtiene la fecha de ma√±ana en formato YYYY-MM-DD para filtrado. */
        function getTomorrowDateString() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().substring(0, 10);
        }

        /** Verifica si son las 10:00 PM o m√°s tarde y muestra las citas del d√≠a siguiente. */
        function checkAndScheduleDailyReminder() {
            const now = new Date();
            const targetHour = 22; // 10 PM
            
            if (now.getHours() >= targetHour) {
                const todayDateString = now.toISOString().substring(0, 10);
                const reminderShownKey = `reminder_shown_${todayDateString}`;
                
                if (localStorage.getItem(reminderShownKey) === 'true') {
                    console.log('Recordatorio de ma√±ana ya mostrado hoy.');
                    return; 
                }

                const tomorrowDateString = getTomorrowDateString();
                const appointmentsTomorrow = appointments.filter(apt => 
                    apt.dateTime.startsWith(tomorrowDateString)
                );
                
                let title = '';
                let content = '';
                const appointmentIcon = '<i class="fas fa-calendar-check text-accent mr-2"></i>'; // Icono

                if (appointmentsTomorrow.length > 0) {
                    title = `üîî Citas para Ma√±ana (${tomorrowDateString.split('-').reverse().join('/')})`;
                    content = appointmentsTomorrow.map(apt => {
                        const timeOnly = formatDateTime(apt.dateTime).split(' a las ')[1];
                        return `
                            <div class="border-l-4 border-accent pl-3 py-2 bg-gray-800 rounded-lg flex items-center">
                                <span class="text-sm text-gray-400 mr-2">${appointmentIcon}</span>
                                <div>
                                    <p class="font-semibold text-white text-base">${apt.name}</p>
                                    <p class="text-sm text-gray-400">Hora: ${timeOnly}</p>
                                </div>
                            </div>
                        `;
                    }).join('<div class="h-3"></div>');
                } else {
                    title = `‚úÖ Ma√±ana Despejada (${tomorrowDateString.split('-').reverse().join('/')})`;
                    content = `<p class="text-gray-400 text-center py-4">¬°Excelente! No tienes citas agendadas para ma√±ana.</p>`;
                }
                
                showDailyReminderModal(title, content);
                localStorage.setItem(reminderShownKey, 'true');
            }
        }
        
        // =======================================================
        // REGISTRO DEL SERVICE WORKER (PARA LA FUNCI√ìN PWA) üü¢ A√ëADIDO
        // =======================================================

        /** Funci√≥n para registrar el Service Worker. */
        function registerServiceWorker() {
            // Verifica si el navegador soporta Service Workers (necesario para PWA)
            if ('serviceWorker' in navigator) {
                // Registra el Service Worker una vez que la p√°gina haya cargado
                window.addEventListener('load', () => {
                    // Usamos una ruta relativa para mayor compatibilidad
                    navigator.serviceWorker.register('service-worker.js') 
                      .then(registration => {
                        console.log('ServiceWorker registrado con √©xito:', registration.scope);
                      })
                      .catch(error => {
                        console.log('Fallo el registro de ServiceWorker:', error);
                      });
                });
            } else {
                console.log('El navegador no soporta Service Workers. La funci√≥n PWA no estar√° disponible.');
            }
        }
        
        // =======================================================
        // INICIO DE LA APLICACI√ìN
        // =======================================================
        
        window.onload = () => {
            appointments = loadAppointments();
            renderView();
            checkAndScheduleDailyReminder(); 
            
            // üü¢ LLAMADA A LA FUNCI√ìN PWA
            registerServiceWorker(); 
        };
    </script>
</body>
</html>