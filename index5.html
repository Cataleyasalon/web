<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cataleya Citas</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#1a1f25; --card:rgba(255,255,255,0.03); --glass:rgba(167,139,250,0.10);
  --purple:#a78bfa; --purple-2:#8b5cf6; --muted:#cbd5e1;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:var(--bg);color:var(--muted);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;display:flex;align-items:flex-start;justify-content:center;padding:28px;}
.container{width:100%;max-width:900px;}
.header{border-radius:12px 12px 0 0;overflow:hidden;height:150px;background:linear-gradient(90deg,var(--purple),var(--purple-2));display:flex;align-items:center;justify-content:center;color:white;font-size:20px;font-weight:700}
.card{background:var(--card);backdrop-filter:blur(6px);padding:20px;border-radius:0 0 12px 12px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
.row{display:grid;grid-template-columns:1fr;gap:12px}
.btn{display:block;width:100%;padding:14px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--purple),var(--purple-2));color:white}
.btn-white{background:rgba(255,255,255,0.03);color:white;border:1px solid rgba(167,139,250,0.08)}
.btn-gray{background:#2b3440;color:white}
.btn-danger{background:#ef4444;color:white}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
.list-item{background:var(--glass);padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(167,139,250,0.12);margin-bottom:8px}
.small{font-size:13px;color:#e6e9ef}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center}
.modal-card{background:rgba(20,24,30,0.8);border:1px solid rgba(167,139,250,0.14);padding:18px;border-radius:12px;color:var(--muted);backdrop-filter:blur(6px);max-width:480px}
.footer-note{font-size:12px;color:#9aa4b2;margin-top:10px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">Cataleya Citas</div>
  <div class="card">
    <div id="app" class="row"></div>
    <div class="footer-note">Instala como PWA para recibir notificaciones a√∫n con la app cerrada.</div>
  </div>
</div>

<!-- audio for reminders -->
<audio id="alarm" src="alarma.mp3" preload="auto"></audio>

<!-- App script -->
<script>
const STORAGE_KEY = 'cataleya_v34_appointments';
let appointments = [];
let reminderTimer = null;

const app = document.getElementById('app');
const alarm = document.getElementById('alarm');

function showModal(text){
  let m = document.createElement('div'); m.className='modal'; m.innerHTML=`
    <div class="modal-card"><div>${text.replace(/\n/g,'<br>')}</div><div style="text-align:right;margin-top:12px"><button id="mclose" class="btn btn-primary">Entendido</button></div></div>`;
  document.body.appendChild(m);
  document.getElementById('mclose').onclick = ()=> document.body.removeChild(m);
}

function ensureArray(v){ return Array.isArray(v)? v : []; }

function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); const parsed = raw ? JSON.parse(raw) : []; appointments = ensureArray(parsed); }catch(e){ console.warn('load error', e); appointments = []; localStorage.removeItem(STORAGE_KEY); } return appointments; }
function save(a){ try{ const arr = ensureArray(a); appointments = arr; localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); // inform service worker
  if(navigator.serviceWorker && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({type:'UPDATE_APPOINTMENTS', appointments: arr});
  } 
  return true; }catch(e){ console.error(e); return false; } }

// UI renderers
function renderHome(){
  app.innerHTML = `
    <button id="addBtn" class="btn btn-primary">AGENDAR NUEVA CITA</button>
    <button id="viewBtn" class="btn btn-white">VER CITAS</button>
    <button id="calBtn" class="btn btn-gray">VER CALENDARIO</button>
    <button id="cancelBtn" class="btn btn-danger">CANCELAR CITA</button>`;
  document.getElementById('addBtn').onclick = renderAdd;
  document.getElementById('viewBtn').onclick = renderView;
  document.getElementById('calBtn').onclick = renderCalendar;
  document.getElementById('cancelBtn').onclick = renderCancel;
}

function renderAdd(){
  const now = new Date().toISOString().slice(0,16);
  app.innerHTML = `
    <h3 style="color:white">Agendar Cita</h3>
    <input id="name" class="input" placeholder="Nombre del cliente">
    <input id="date" type="datetime-local" class="input" value="${now}">
    <button id="confirm" class="btn btn-primary">Confirmar Cita</button>
    <button id="back" class="btn btn-gray">Volver</button>`;
  document.getElementById('back').onclick = ()=> (load(), renderHome());
  document.getElementById('confirm').onclick = async ()=>{
    const name = document.getElementById('name').value.trim();
    const date = document.getElementById('date').value;
    if(!name || !date) return showModal('‚ö†Ô∏è Debes completar todos los campos.');
    const dt = new Date(date);
    if(isNaN(dt.getTime())) return showModal('‚ùå Fecha inv√°lida');
    const apt = { id: 'id-'+Date.now()+'-'+Math.random().toString(16).slice(2), name, dateTime: dt.toISOString(), createdAt: new Date().toISOString() };
    const arr = ensureArray(load()); arr.push(apt);
    const ok = save(arr);
    if(ok){ showModal('‚úÖ La cita se registr√≥ con √©xito'); startReminder(); setTimeout(()=> renderHome(),900); } else showModal('‚ùå No se pudo guardar la cita');
  }
}

function renderView(){
  load();
  const now = Date.now();
  const list = appointments.filter(a=> new Date(a.dateTime).getTime() >= now).sort((a,b)=> new Date(a.dateTime)-new Date(b.dateTime));
  if(!list.length){
    app.innerHTML = `<p class="small">üí§ No hay citas programadas a partir de hoy.</p><button class="btn btn-gray" id="back">Volver</button>`;
    document.getElementById('back').onclick = ()=> renderHome();
    return;
  }
  app.innerHTML = `<div id="list"></div><button class="btn btn-gray" id="back">Volver</button>`;
  document.getElementById('back').onclick = ()=> renderHome();
  const listEl = document.getElementById('list');
  list.forEach(a=>{
    const item = document.createElement('div'); item.className='list-item';
    item.innerHTML = `<div><div style="color:var(--purple);font-weight:700">${a.name}</div><div class="small">${new Date(a.dateTime).toLocaleString()}</div></div><div><button class="btn btn-danger" data-id="${a.id}">Cancelar</button></div>`;
    listEl.appendChild(item);
  });
  listEl.querySelectorAll('button').forEach(b=> b.onclick = async (e)=>{
    const id = e.currentTarget.dataset.id;
    const arr = ensureArray(load()).filter(x=> x.id !== id);
    save(arr);
    renderView();
  });
}

function renderCalendar(){
  load();
  const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
  const first = new Date(y,m,1).getDay()||7, days = new Date(y,m+1,0).getDate();
  const map = appointments.reduce((acc,b)=>{ const k = b.dateTime.slice(0,10); (acc[k]=acc[k]||[]).push(b); return acc; }, {});
  let grid = '';
  for(let i=1;i<first;i++) grid += '<div></div>';
  for(let d=1; d<=days; d++){
    const key = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const da = map[key] || [];
    grid += `<div class="list-item" onclick="showDay('${key}')"><div style="text-align:right;font-weight:700">${d}</div><div>${da.map(x=>`<div class='small'>${x.name}</div>`).join('')}</div></div>`;
  }
  app.innerHTML = `<h3 style="color:white">${currentCalendarDate.toLocaleDateString(undefined,{month:'long',year:'numeric'})}</h3><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px">${grid}</div><div style="text-align:center;margin-top:12px"><button id="back" class="btn btn-primary" style="font-size:18px;padding:12px 20px"><span style="margin-right:10px">‚¨ÖÔ∏è</span>Volver al men√∫</button></div>`;
  document.getElementById('back').onclick = ()=> renderHome();
}

function renderCancel(){
  load();
  if(!appointments.length){ app.innerHTML = '<p class="small">No hay citas.</p><button class="btn btn-gray" id="back">Volver</button>'; document.getElementById('back').onclick = ()=> renderHome(); return; }
  app.innerHTML = appointments.map(a=>`<div class="list-item"><div><div style="color:var(--purple);font-weight:700">${a.name}</div><div class="small">${new Date(a.dateTime).toLocaleString()}</div></div><div><button class="btn btn-danger" data-id="${a.id}">Cancelar</button></div></div>`).join('')+`<button class="btn btn-gray" id="back">Volver</button>`;
  document.getElementById('back').onclick = ()=> renderHome();
  document.querySelectorAll('[data-id]').forEach(b=> b.onclick = (e)=>{ const id = e.currentTarget.dataset.id; const arr = ensureArray(load()).filter(x=> x.id !== id); save(arr); renderCancel(); });
}

function showDay(k){
  load();
  const list = appointments.filter(a=> a.dateTime.startsWith(k));
  if(!list.length) return showModal('No hay citas en esta fecha.');
  showModal(list.map(a=> `${a.name} - ${new Date(a.dateTime).toLocaleTimeString()}`).join('\n'));
}

// Reminder logic: starts/continues a 5-minute checker and notifies 5 minutes before
function startReminder(){
  if(reminderTimer) return;
  // run immediately then every 5 minutes
  const check = ()=>{
    load();
    const now = Date.now();
    // find appointments where (dateTime - now) is between 0 and 5*60*1000 (i.e., within next 5 minutes)
    const upcoming = appointments.filter(a=>{
      const t = new Date(a.dateTime).getTime();
      const diff = t - now;
      return diff > 0 && diff <= 5*60*1000 && !a._notified;
    });
    upcoming.forEach(a=>{
      // mark local to avoid duplicate notifications in same session
      a._notified = true;
      // show detailed notification via service worker (if registered) or Notification API
      const title = `üîî Cita con ${a.name}`;
      const body = `Tu cita es a las ${new Date(a.dateTime).toLocaleTimeString()}`;
      const options = { body, icon: 'icono192.png', badge: 'icono192.png', data: { id: a.id } };
      // try via service worker for better background behavior
      if(navigator.serviceWorker && navigator.serviceWorker.controller){
        try{ navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', title, options }); }catch(e){ console.warn('sw post failed', e); new Notification(title, options); }
      } else {
        try{ new Notification(title, options); }catch(e){ console.warn('Notification failed', e); }
      }
      // try play sound (works only if page has audio context open)
      try{ alarm.currentTime = 0; alarm.play().catch(()=>{}); }catch(e){}
    });
    // persist notified flags to storage (remove transient flags before save)
    const clean = appointments.map(a=>{ const copy = Object.assign({}, a); delete copy._notified; return copy; });
    save(clean);
  };
  check();
  reminderTimer = setInterval(check, 5*60*1000);
}

// Service Worker registration and message handling
async function registerSW(){
  if('serviceWorker' in navigator){
    try{
      const reg = await navigator.serviceWorker.register('service-worker.js');
      console.log('SW registered', reg);
      // send initial appointments to SW
      if(reg.active){
        reg.active.postMessage({ type: 'UPDATE_APPOINTMENTS', appointments: load() });
      }
      navigator.serviceWorker.addEventListener('message', ev=>{
        if(ev.data && ev.data.type === 'PLAY_ALARM_SOUND'){ try{ alarm.currentTime = 0; alarm.play().catch(()=>{});}catch(e){} }
      });
    }catch(e){ console.warn('SW register failed', e); }
  }
}

// Request notification permission early (but non-intrusive)
function ensureNotificationPermission(){ if(Notification.permission !== 'granted') Notification.requestPermission().catch(()=>{}); }

// init
let currentCalendarDate = new Date();
document.addEventListener('DOMContentLoaded', ()=>{ load(); renderHome(); registerSW(); ensureNotificationPermission(); if(appointments.length) startReminder(); });

</script>
</body>
</html>
