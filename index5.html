<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Citas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'primary-dark': '#0d1117',
                        'secondary-dark': '#161b22',
                        'accent': '#a78bfa',
                        'accent-hover': '#8b5cf6',
                        'cancel': '#f87171',
                        'day-base': '#1f2937',
                        'day-current': '#374151',
                        'day-other': '#111827',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0d1117;
            color: #d1d5db;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
        }
        .card {
            background-color: #161b22;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        .header-image-container {
            width: 100%;
            max-height: 150px;
            overflow: hidden;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        .header-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }
        .appointment-item { border-left: 3px solid #a78bfa; }
        .appointment-item:hover { background-color: #2d3748; }

        .calendar-day {
            min-height: 75px;
            transition: all 0.2s;
        }
        .calendar-day.active-month {
            cursor: pointer;
        }
        .calendar-day.active-month:hover {
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.3);
            transform: scale(1.02);
            z-index: 10;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

    <audio id="reminder-sound" src="alarma.mp3" preload="auto"></audio>

    <div class="w-full max-w-lg mx-4 transition-all duration-300">

        <div class="header-image-container">
            <img src="cabecera.png" alt="Cabecera del Negocio" class="header-image">
        </div>

        <div id="app" class="card p-6 sm:p-8 lg:p-10 w-full rounded-b-xl">
            <div id="view-container"></div>

            <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-secondary-dark p-6 rounded-lg max-w-sm w-full text-center border border-accent">
                    <p id="modal-text" class="text-white text-lg mb-4"></p>
                    <button onclick="closeModal()" class="bg-accent hover:bg-accent-hover text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md shadow-violet-700/50">
                        Entendido
                    </button>
                </div>
            </div>

            <div id="reminder-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
                <div class="bg-secondary-dark p-6 rounded-xl max-w-sm w-full text-left border border-accent shadow-2xl shadow-violet-700/50 transform transition-all duration-300 scale-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="reminder-title" class="text-xl font-bold text-accent"></h3>
                        <button onclick="closeReminderModal()" class="text-gray-400 hover:text-white transition duration-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="reminder-content" class="text-gray-300 space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
                    <button onclick="closeReminderModal()" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
/* =======================================================
   VARIABLES Y CONFIGURACIÓN
======================================================= */
const STORAGE_KEY = 'cataleya_appointments_data';
let currentView = 'home';
let currentCalendarDate = new Date();
let appointments = [];
let recognition = null;

const monthMap = {
    'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5,
    'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
};
const headerNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

const viewContainer = document.getElementById('view-container');
const messageModal = document.getElementById('message-modal');
const modalText = document.getElementById('modal-text');

/* =======================================================
   UTILIDADES Y FUNCIONES BÁSICAS
======================================================= */
function showModal(msg){ modalText.textContent=msg; messageModal.classList.remove('hidden'); }
function closeModal(){ messageModal.classList.add('hidden'); }
function closeReminderModal(){ document.getElementById('reminder-modal').classList.add('hidden'); }

function formatDateTime(date){
    const d=new Date(date);
    const dateStr=d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'});
    const timeStr=d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
    return `${dateStr} a las ${timeStr}`;
}
function formatTime(date){
    const d=new Date(date);
    return d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
}

/* =======================================================
   GESTIÓN LOCALSTORAGE
======================================================= */
function saveAppointments(apts,timestamp=Date.now()){
    const data={appointments:apts,lastResetTimestamp:timestamp};
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}
function loadAppointments(){
    const storedData=localStorage.getItem(STORAGE_KEY);
    if(!storedData){saveAppointments([]);return[];}
    const data=JSON.parse(storedData);
    return data.appointments.sort((a,b)=>new Date(a.dateTime)-new Date(b.dateTime));
}

/* =======================================================
   RENDERIZADO PRINCIPAL
======================================================= */
function setView(v){ currentView=v; renderView(); }

function renderHome(){
    viewContainer.innerHTML=`
        <div class="space-y-4">
            <button onclick="startSpeechRecognition()"
                class="w-full bg-accent hover:bg-accent-hover text-white text-lg font-extrabold py-4 px-6 rounded-xl transition duration-300 shadow-xl shadow-violet-700/30 flex items-center justify-center">
                <i class="fas fa-microphone text-2xl mr-3"></i> AGENDAR CITA (DICTADO)
            </button>
            <button onclick="setView('calendar')" class="w-full bg-secondary-dark hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg border border-gray-700">
                <i class="fas fa-calendar-alt mr-3"></i> VER CALENDARIO
            </button>
            <button onclick="setView('cancel')" class="w-full bg-cancel hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg border border-red-600">
                <i class="fas fa-times-circle mr-3"></i> CANCELAR CITA
            </button>
        </div>`;
}

function renderView(){
    appointments=loadAppointments();
    switch(currentView){
        case 'calendar': renderCalendar(); break;
        case 'cancel': renderCancel(); break;
        default: renderHome(); break;
    }
}

/* =======================================================
   RENDERIZAR CALENDARIO
======================================================= */
function renderCalendar(){
    const today=new Date();
    today.setHours(0,0,0,0);
    const y=currentCalendarDate.getFullYear(), m=currentCalendarDate.getMonth();
    const firstDay=new Date(y,m,1);
    let start=firstDay.getDay(); if(start===0)start=6; else start--;
    const daysInMonth=new Date(y,m+1,0).getDate();

    const appointmentsByDay=appointments.reduce((a,apt)=>{
        const k=new Date(apt.dateTime).toISOString().substring(0,10);
        if(!a[k])a[k]=[]; a[k].push(apt); return a;
    },{});
    const title=currentCalendarDate.toLocaleDateString('es-ES',{month:'long',year:'numeric'});
    let html='';
    for(let i=0;i<start;i++)html+=`<div class="calendar-day bg-day-other"></div>`;
    for(let d=1;d<=daysInMonth;d++){
        const cd=new Date(y,m,d);
        const key=cd.toISOString().substring(0,10);
        const dayApps=(appointmentsByDay[key]||[]).sort((a,b)=>new Date(a.dateTime)-new Date(b.dateTime));
        const isToday=today.toDateString()===cd.toDateString();
        const has=dayApps.length>0;
        let cls='bg-day-base border border-gray-700 active-month';
        if(isToday)cls='bg-day-current border-2 border-accent shadow-lg active-month';
        else if(has)cls='bg-day-base border border-accent/70 active-month';
        const items=dayApps.slice(0,2).map(a=>`
            <div class="appointment-item p-0.5 ml-1 mb-0.5 rounded-sm bg-gray-800 flex justify-between items-center">
                <p class="text-[10px] text-white truncate">${a.name}</p>
                <p class="text-[9px] font-mono text-gray-400">${formatTime(a.dateTime)}</p>
            </div>`).join('');
        html+=`<div class="calendar-day p-1 rounded-lg flex flex-col ${cls}" onclick="showDayDetails('${key}')">
            <span class="text-sm ${isToday?'text-accent font-bold':'text-white font-semibold'} self-end">${d}</span>
            <div class="flex-grow overflow-y-auto custom-scrollbar">${items}</div>
        </div>`;
    }
    viewContainer.innerHTML=`
        <div class="flex justify-between items-center mb-4">
            <button onclick="setView('home')" class="bg-accent text-white p-2 rounded-lg"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-base font-bold text-white uppercase">${title}</h2>
        </div>
        <div class="grid grid-cols-7 gap-1.5 text-xs font-bold text-center text-accent mb-2">
            ${headerNames.map(n=>`<div>${n}</div>`).join('')}
        </div>
        <div class="grid grid-cols-7 gap-1.5 max-h-[70vh] overflow-y-auto custom-scrollbar p-1">${html}</div>`;
}

function showDayDetails(key){
    const apps=appointments.filter(a=>a.dateTime.startsWith(key));
    const dateParts=key.split('-');
    const title=`Citas para el ${new Date(dateParts[0],dateParts[1]-1,dateParts[2]).toLocaleDateString('es-ES',{day:'numeric',month:'long',year:'numeric'})}`;
    let content=apps.length?apps.map(a=>`
        <div class="border-l-4 border-accent pl-3 py-2 bg-gray-800 rounded-lg flex justify-between items-center">
            <p class="font-semibold text-white">${a.name}</p>
            <p class="text-sm text-gray-400 font-mono">${formatTime(a.dateTime)}</p>
        </div>`).join('<div class="h-3"></div>'):`<p class="text-white text-center py-4">¡Día libre!</p>`;
    document.getElementById('reminder-title').textContent=title;
    document.getElementById('reminder-content').innerHTML=content;
    document.getElementById('reminder-modal').classList.remove('hidden');
}

/* =======================================================
   CANCELAR / AGREGAR CITAS
======================================================= */
function addAppointment(name,date){
    const newA={id:crypto.randomUUID(),name:name.trim(),dateTime:new Date(date).toISOString()};
    if(new Date(newA.dateTime)<Date.now()){showModal('No puedes agendar en el pasado');return;}
    if(appointments.some(a=>a.dateTime===newA.dateTime)){showModal('Ya hay cita en esa hora');return;}
    appointments.push(newA); saveAppointments(appointments); sendAppointmentsToSW();
    showModal(`✅ ¡Cita agendada! ${name} el ${formatDateTime(newA.dateTime)}`);
    setView('home');
}
function renderCancel(){
    const c=appointments.map(a=>`
        <div class="appointment-item p-4 mb-2 bg-secondary-dark rounded-lg flex justify-between items-center border border-gray-700" id="apt-${a.id}">
            <div><p class="text-accent font-bold">${a.name}</p><p class="text-sm text-gray-400">${formatDateTime(a.dateTime)}</p></div>
            <button onclick="confirmCancelAppointment('${a.id}')" class="text-cancel hover:text-red-300 font-bold py-1 px-3 rounded-lg border border-cancel">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>`).join('');
    viewContainer.innerHTML=`<h2 class="text-2xl font-bold text-white mb-4">Cancelar Citas</h2>${c}`;
}
function confirmCancelAppointment(id){
    const a=appointments.find(x=>x.id===id);
    appointments=appointments.filter(x=>x.id!==id);
    saveAppointments(appointments); sendAppointmentsToSW();
    showModal(`Cita de ${a.name} cancelada.`); renderCancel();
}

/* =======================================================
   INICIO + SERVICE WORKER + ALARMAS
======================================================= */
document.addEventListener('DOMContentLoaded',()=>{
    appointments=loadAppointments(); renderView();
});

if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js')
        .then(()=>{ console.log('[App] SW registrado'); sendAppointmentsToSW(); })
        .catch(e=>console.error('SW error',e));
}

function sendAppointmentsToSW(){
    if(navigator.serviceWorker.controller){
        navigator.serviceWorker.controller.postMessage({
            type:'UPDATE_APPOINTMENTS',
            appointments:appointments
        });
    }
}

const originalSaveAppointments=saveAppointments;
saveAppointments=function(apts,timestamp){
    originalSaveAppointments(apts,timestamp);
    sendAppointmentsToSW();
};

if('serviceWorker' in navigator){
    navigator.serviceWorker.addEventListener('message',event=>{
        if(event.data && event.data.type==='PLAY_ALARM_SOUND'){
            try{
                const s=document.getElementById('reminder-sound');
                s.currentTime=0; s.play().catch(e=>console.warn('Sonido bloqueado:',e));
            }catch(err){console.error('Error sonido',err);}
        }
    });
}
</script>
</body>
</html>
