<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Citas - Men√∫ de 3 Opciones Original</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-dark: #1f2937;
            --secondary-dark: #374151;
            --accent: #ef4444;
            --occupied-day: #10b981;
        }
        body {
            background-color: var(--primary-dark);
        }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        .view-container {
            background-color: var(--secondary-dark);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-cell {
            background-color: var(--secondary-dark);
            height: 80px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 0.375rem; cursor: pointer;
            transition: background-color 0.15s;
        }
        .day-name {
            height: 30px; background-color: var(--primary-dark);
            color: var(--accent); cursor: default;
        }
        .day-cell.disabled { cursor: not-allowed; background-color: var(--primary-dark); }
        .occupied-dot { width: 8px; height: 8px; background-color: var(--occupied-day); border-radius: 50%; margin-top: 4px; }
        .btn-primary { background-color: var(--accent); transition: background-color 0.15s; }
        .btn-primary:hover { background-color: #dc2626; }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-6 p-4 bg-secondary-dark rounded-lg">
            <h1 class="text-4xl font-extrabold text-white">Gestor de Citas <i class="fas fa-clock text-accent ml-2"></i></h1>
        </header>
        
        <nav class="flex justify-center space-x-4 mb-6 p-3 bg-gray-800 rounded-lg">
            <button onclick="setView('home')" class="text-white hover:text-accent font-semibold py-2 px-4 rounded transition duration-200">
                <i class="fas fa-home mr-1"></i> Inicio
            </button>
            <button onclick="setView('calendar')" class="text-white hover:text-accent font-semibold py-2 px-4 rounded transition duration-200">
                <i class="fas fa-calendar-alt mr-1"></i> Calendario
            </button>
        </nav>

        <div id="viewContainer" class="view-container"></div>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center hidden z-50" onclick="hideModal()">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800">Mensaje</h3>
                <p id="modalMessage" class="mb-6 text-gray-600"></p>
                <div id="modalActions" class="flex justify-end space-x-3">
                    <button id="modalCloseButton" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition duration-150">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'appointment_manager_data';
        let appointments = [];
        let currentCalendarDate = new Date();
        let currentView = 'home';
        
        const viewContainer = document.getElementById('viewContainer');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');

        // ======= UTILIDADES =======
        function formatDateOnly(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toISOString().substring(0, 10);
        }
        function formatDateTimeDisplay(dateTimeStr) {
            const date = new Date(dateTimeStr);
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleDateString('es-ES', options);
        }
        function showModal(title, message, isError = false, confirmationCallback = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActions.innerHTML = '';
            if (confirmationCallback) {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition duration-150';
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.onclick = () => { confirmationCallback(); hideModal(); };
                modalActions.appendChild(confirmBtn);
            }
            const closeBtn = document.createElement('button');
            closeBtn.id = 'modalCloseButton';
            closeBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition duration-150';
            closeBtn.textContent = confirmationCallback ? 'Cancelar' : 'Cerrar';
            closeBtn.onclick = hideModal;
            modalActions.appendChild(closeBtn);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        function hideModal() {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        // ======= LOCAL STORAGE =======
        function saveAppointments(apts) {
            const data = { appointments: apts, lastSaveTimestamp: Date.now() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadAppointments() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (!storedData) return [];
            const data = JSON.parse(storedData);
            
            // üîπ Eliminar citas con m√°s de 4 meses
            const now = new Date();
            const fourMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 4, now.getDate());
            const filtered = data.appointments.filter(apt => new Date(apt.dateTime) >= fourMonthsAgo);
            
            if (filtered.length !== data.appointments.length) {
                saveAppointments(filtered);
            }

            return filtered.sort((a,b)=>new Date(a.dateTime)-new Date(b.dateTime));
        }

        // ======= L√ìGICA DE CITAS =======
        function addAppointment(dateStr, timeStr) {
            const dateTimeStr = `${dateStr}T${timeStr}:00`;
            const newAppointmentDate = new Date(dateTimeStr);
            const now = new Date();

            if (newAppointmentDate <= now) {
                showModal('Error', 'No se puede agendar en el pasado.', true);
                return;
            }

            // üîπ Validar disponibilidad solo dentro del mismo d√≠a
            const sameDayAppointments = appointments.filter(a => formatDateOnly(a.dateTime) === dateStr);
            const isAvailable = sameDayAppointments.every(a => {
                const existing = new Date(a.dateTime);
                const diff = Math.abs(existing - newAppointmentDate);
                return diff >= 30 * 60 * 1000;
            });

            if (!isAvailable) {
                showModal('Error', 'Ya existe una cita muy cercana en este d√≠a (m√≠nimo 30 min).', true);
                return;
            }

            appointments.push({ id: Date.now(), dateTime: newAppointmentDate.toISOString() });
            saveAppointments(appointments);
            showModal('Cita Agendada', `Cita para el ${formatDateTimeDisplay(newAppointmentDate.toISOString())}.`);
            setView('calendar');
        }

        // ======= RESTO IGUAL =======
        function cancelAppointment(id) {
            appointments = appointments.filter(apt => apt.id !== id);
            saveAppointments(appointments);
            showModal('Cita Cancelada', 'La cita fue eliminada.');
            setView('calendar');
        }

        function scheduleWithVoice() { showModal('Dictado no disponible', 'Funci√≥n en desarrollo.'); setView('calendar'); }
        function viewAppointments() { setView('calendar'); }
        function deleteAppointments() {
            showModal('Borrar Citas','¬øSeguro que deseas borrar TODAS?',true,()=>{appointments=[];saveAppointments([]);showModal('Hecho','Todas las citas fueron borradas.');setView('home');});
        }

        // ======= VISTAS =======
        function setView(v,data=null){
            if(v==='home') renderHome();
            else if(v==='calendar') renderCalendar();
            else if(v==='dayDetails') showDayDetails(data);
            else if(v==='schedule') renderScheduleForm(data);
        }

        function renderHome(){
            viewContainer.innerHTML=`
                <h2 class="text-2xl font-bold text-white mb-6">Selecciona una opci√≥n:</h2>
                <div class="space-y-4">
                    <button onclick="scheduleWithVoice()" class="w-full btn-primary text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-microphone-alt mr-3"></i> Agendar Cita con Dictado
                    </button>
                    <button onclick="viewAppointments()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-eye mr-3"></i> Ver Citas
                    </button>
                    <button onclick="deleteAppointments()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-trash-alt mr-3"></i> Borrar Citas (Todas)
                    </button>
                </div>
            `;
        }

        // resto de tu c√≥digo id√©ntico excepto el horario:
        function renderScheduleForm(dateStr){
            const date=new Date(dateStr);
            const formattedDate=date.toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
            viewContainer.innerHTML=`
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i class="fas fa-calendar-plus mr-2 text-accent"></i> Agendar Cita para el <span class="text-accent ml-2">${formattedDate}</span>
                </h2>
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Hora de la Cita:</label>
                        <input type="time" id="timeInput" required min="06:00" max="20:00" step="1800"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-accent focus:border-accent"
                            value="09:00">
                        <p class="text-xs text-gray-400 mt-1">Horario de 6:00 AM a 8:00 PM, intervalos de 30 minutos.</p>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg shadow-md">
                        <i class="fas fa-check-circle mr-2"></i> Confirmar Cita
                    </button>
                </form>
                <button onclick="setView('dayDetails','${dateStr}')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </button>`;
            document.getElementById('scheduleForm').addEventListener('submit',e=>{
                e.preventDefault();
                const time=document.getElementById('timeInput').value;
                addAppointment(dateStr,time);
            });
        }

        function init(){ appointments=loadAppointments(); setView('home'); }
        document.addEventListener('DOMContentLoaded',init);
    </script>
</body>
</html>
