<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cataleya Citas</title>
<link rel="manifest" href="manifest.json">
<style>
:root {
  --bg:#1b2230;
  --lavanda:#a78bfa;
  --lavanda2:#8b5cf6;
  --card:rgba(255,255,255,0.04);
  --text:#e5e7eb;
  --fade:0.5s;
}
*{box-sizing:border-box;margin:0;padding:0}
body {
  font-family:'Inter',system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
  padding:20px;
  animation:fadeIn var(--fade) ease-in-out both;
  background-image:radial-gradient(circle at 50% 15%,rgba(167,139,250,0.06),transparent 40%);
}
@keyframes fadeIn {from{opacity:0;filter:blur(6px);}to{opacity:1;filter:blur(0);}}
.cabecera{
  width:100%;max-width:900px;
  background:rgba(255,255,255,0.02);
  border-radius:16px;overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
  margin-bottom:20px;
}
.cabecera img{width:100%;height:auto;max-height:180px;object-fit:contain;background:#111;display:block;}
.card{
  width:100%;max-width:900px;
  background:var(--card);
  border-radius:16px;
  backdrop-filter:blur(6px);
  box-shadow:0 8px 40px rgba(0,0,0,0.6);
  padding:24px;
}
.btn{
  display:block;width:100%;
  padding:16px;
  border:none;border-radius:14px;
  margin-bottom:14px;
  font-weight:700;font-size:18px;
  cursor:pointer;transition:all .2s ease;
}
.btn-primary{background:linear-gradient(90deg,var(--lavanda),var(--lavanda2));color:#fff;}
.btn-gray{background:rgba(255,255,255,0.04);color:#fff;border:1px solid rgba(255,255,255,0.08);}
.btn-danger{background:#ef4444;color:#fff;}
.btn:hover{box-shadow:0 0 18px rgba(139,92,246,0.25);transform:scale(1.02);}
.input{
  width:100%;padding:14px;margin-bottom:10px;
  border-radius:12px;border:1px solid rgba(255,255,255,0.06);
  background:transparent;color:var(--text);
}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;width:100%;margin-top:16px;
}
.day{
  background:rgba(255,255,255,0.03);
  border-radius:10px;text-align:center;
  padding:10px;min-height:70px;
  display:flex;flex-direction:column;
  justify-content:space-between;
  position:relative;transition:all .2s ease;
}
.day:hover{transform:translateY(-3px);box-shadow:0 0 12px rgba(167,139,250,0.15);}
.day .num{font-weight:700;color:var(--text);}
.day .items{font-size:13px;color:#cbd5e1;}
.glow-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--lavanda);
  position:absolute;left:50%;bottom:6px;
  transform:translateX(-50%);
  box-shadow:0 0 8px var(--lavanda2);
}
.footer-btn{display:flex;justify-content:center;margin-top:20px;}
.footer-btn button{
  padding:14px 24px;
  border:none;border-radius:14px;
  background:linear-gradient(90deg,var(--lavanda),var(--lavanda2));
  color:white;font-weight:700;font-size:17px;
  box-shadow:0 0 18px rgba(139,92,246,0.2);
}
.footer-btn button:hover{
  transform:scale(1.03);
  box-shadow:0 0 22px rgba(139,92,246,0.35);
}
@media(max-width:600px){
  .btn{font-size:16px;padding:14px;}
  .day{min-height:60px;}
  .cabecera img{max-height:130px;}
}
</style>
</head>
<body>

<div class="cabecera">
  <img src="cabecera.png" alt="Cataleya Citas">
</div>

<div class="card">
  <div id="app"></div>
</div>

<audio id="alarm" src="alarma.mp3" preload="auto"></audio>

<script>
// ======== Cataleya Citas v36.2 ========
const STORAGE_KEY = 'cataleya_v36_appointments';
let appointments = [];
let reminderTimer = null;
const app = document.getElementById('app');
const alarm = document.getElementById('alarm');

function fadePage(){
  document.body.style.animation='none';
  void document.body.offsetWidth;
  document.body.style.animation='fadeIn var(--fade) ease-in-out both';
}
function showModal(text){
  alert(text);
}
function load(){
  try{
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    appointments = Array.isArray(data)?data:[];
  }catch{appointments=[];}
  return appointments;
}
function save(a){
  appointments=a;
  localStorage.setItem(STORAGE_KEY,JSON.stringify(a));
  if(navigator.serviceWorker?.controller)
    navigator.serviceWorker.controller.postMessage({type:'UPDATE_APPOINTMENTS',appointments});
}
function renderHome(){
  fadePage();
  app.innerHTML=`
    <button class="btn btn-primary" id="addBtn">AGENDAR NUEVA CITA</button>
    <button class="btn btn-gray" id="viewBtn">VER CITAS</button>
    <button class="btn btn-gray" id="calBtn">VER CALENDARIO</button>
    <button class="btn btn-danger" id="cancelBtn">CANCELAR CITA</button>
  `;
  addBtn.onclick=renderAdd;
  viewBtn.onclick=renderView;
  calBtn.onclick=renderCalendar;
  cancelBtn.onclick=renderCancel;
}
function renderAdd(){
  fadePage();
  const now=new Date().toISOString().slice(0,16);
  app.innerHTML=`
    <h3>Agendar Cita</h3>
    <input id="name" class="input" placeholder="Nombre del cliente">
    <input id="date" type="datetime-local" class="input" value="${now}">
    <button class="btn btn-primary" id="confirm">Confirmar</button>
    <button class="btn btn-gray" id="back">Volver</button>
  `;
  back.onclick=renderHome;
  confirm.onclick=()=>{
    const name=document.getElementById('name').value.trim();
    const date=document.getElementById('date').value;
    if(!name||!date)return showModal('Completa todos los campos.');
    const dt=new Date(date);
    const a={id:Date.now(),name,dateTime:dt.toISOString(),notified:false};
    const list=load();list.push(a);save(list);
    showModal('‚úÖ Cita guardada');
    startReminder();renderHome();
  };
}
function renderView(){
  fadePage();const list=load();
  const now=Date.now();
  const f=list.filter(a=>new Date(a.dateTime)>now);
  if(!f.length)return app.innerHTML='<p>No hay citas programadas.</p><button class="btn btn-gray" onclick="renderHome()">Volver</button>';
  app.innerHTML=f.map(a=>`<div class="day"><div>${a.name}</div><div>${new Date(a.dateTime).toLocaleString()}</div></div>`).join('')+`<div class="footer-btn"><button onclick="renderHome()">‚¨ÖÔ∏è Volver al men√∫</button></div>`;
}
function renderCancel(){
  fadePage();
  const list=load();
  if(!list.length)return app.innerHTML='<p>No hay citas.</p><button class="btn btn-gray" onclick="renderHome()">Volver</button>';
  app.innerHTML=list.map(a=>`<div class="day"><div>${a.name} - ${new Date(a.dateTime).toLocaleString()}</div><button class="btn btn-danger" onclick="cancel('${a.id}')">Cancelar</button></div>`).join('')+`<div class="footer-btn"><button onclick="renderHome()">‚¨ÖÔ∏è Volver al men√∫</button></div>`;
}
function cancel(id){
  const list=load().filter(a=>a.id!=id);
  save(list);
  renderCancel();
}
function renderCalendar(){
  fadePage();
  const list=load();
  const date=new Date();
  const year=date.getFullYear(),month=date.getMonth();
  const first=new Date(year,month,1).getDay();
  const days=new Date(year,month+1,0).getDate();
  const map={};
  list.forEach(a=>{const k=a.dateTime.slice(0,10);(map[k]=map[k]||[]).push(a);});
  let html='';
  for(let i=0;i<first;i++)html+='<div></div>';
  for(let d=1;d<=days;d++){
    const k=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const c=map[k]||[];
    html+=`<div class="day" onclick="showDay('${k}')"><div class="num">${d}</div><div class="items">${c.slice(0,2).map(x=>x.name).join('<br>')}</div>${c.length?'<div class="glow-dot"></div>':''}</div>`;
  }
  app.innerHTML=`<h3 style="text-align:center;text-transform:capitalize">${date.toLocaleDateString('es-ES',{month:'long',year:'numeric'})}</h3><div class="calendar">${html}</div><div class="footer-btn"><button onclick="renderHome()">‚¨ÖÔ∏è Volver al men√∫</button></div>`;
}
function showDay(k){
  const list=load().filter(a=>a.dateTime.startsWith(k));
  if(!list.length)return showModal('No hay citas ese d√≠a.');
  showModal(list.map(a=>`${a.name} - ${new Date(a.dateTime).toLocaleTimeString()}`).join('\n'));
}
function startReminder(){
  if(reminderTimer)return;
  reminderTimer=setInterval(()=>{
    const now=Date.now();const list=load();
    list.forEach(a=>{
      const t=new Date(a.dateTime).getTime();
      if(t-now<=5*60*1000 && t>now && !a.notified){
        a.notified=true;
        save(list);
        new Notification(`üîî Cita con ${a.name}`,{body:`üíú Recuerda tu cita a las ${new Date(a.dateTime).toLocaleTimeString()}`,icon:'icono192.png'});
        alarm.loop=true;alarm.play().catch(()=>{});
      }
    });
  },60000);
}
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
if(Notification.permission!=='granted')Notification.requestPermission();
document.addEventListener('DOMContentLoaded',renderHome);
</script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cataleya Citas</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#1a232b;
  --card:rgba(255,255,255,0.03);
  --glass:rgba(167,139,250,0.10);
  --purple:#a78bfa;
  --purple-2:#8b5cf6;
  --muted:#cbd5e1;
  --fade-dur:0.5s;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--muted);
  display:flex;
  justify-content:center;
  padding:24px;
  overflow-x:hidden;
  animation:fadeIn var(--fade-dur) ease both;
  background-image: radial-gradient(circle at 50% 20%, rgba(167,139,250,0.06), transparent 35%);
}
@keyframes fadeIn{from{opacity:0;filter:blur(6px);}to{opacity:1;filter:blur(0);}}
.container{width:100%;max-width:900px;}
.cab{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  border-radius:14px 14px 0 0;
  background:#111;
  height:auto;
}
.cab img{
  width:100%;
  height:auto;
  max-height:170px;
  object-fit:contain;
  object-position:center;
  border-bottom:1px solid rgba(255,255,255,0.08);
}
.card{
  background:var(--card);
  backdrop-filter:blur(6px);
  padding:20px;
  border-radius:0 0 14px 14px;
  box-shadow:0 12px 35px rgba(0,0,0,0.6);
}
.btn{
  display:inline-block;
  padding:16px 18px;
  border-radius:14px;
  border:0;
  font-weight:700;
  cursor:pointer;
  transition:transform .1s ease, box-shadow .15s ease;
  user-select:none;
  font-size:18px;
}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(90deg,var(--purple),var(--purple-2));color:white;}
.btn-white{background:rgba(255,255,255,0.03);color:white;border:1px solid rgba(167,139,250,0.08);}
.btn-gray{background:#2b3440;color:white;}
.btn-danger{background:#ef4444;color:white;}
.btn:hover{box-shadow:0 0 20px rgba(139,92,246,0.2);}
.input{
  width:100%;padding:14px;
  border-radius:12px;border:1px solid rgba(255,255,255,0.05);
  background:transparent;color:var(--muted);
}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
  justify-items:center;
  margin-top:16px;
  max-width:100%;
  overflow:hidden;
}
.calendar .day{
  background:rgba(255,255,255,0.02);
  border-radius:10px;
  padding:8px;
  width:100%;
  min-height:min(13vw,80px);
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  position:relative;
  text-align:center;
}
.day .num{font-weight:700;font-size:15px;}
.day .items{font-size:13px;margin-top:4px;}
.day .glow-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--purple);
  position:absolute;left:50%;transform:translateX(-50%);
  bottom:8px;
  box-shadow:0 0 10px rgba(167,139,250,0.9);
}
.calendar-footer{
  display:flex;
  justify-content:center;
  margin-top:16px;
  position:relative;
}
@media (max-width:520px){
  .btn{font-size:16px;}
  .calendar .day{min-height:min(14vw,72px);}
  .cab img{max-height:130px;}
}
</style>
</head>
<body>
<div class="container">
  <div class="cab"><img src="cabecera.png" alt="Cabecera Cataleya"></div>
  <div class="card">
    <div id="app" class="row"></div>
  </div>
</div>

<!-- tus scripts originales aqu√≠ -->
<script src="index5_script_v36.js"></script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cataleya Citas</title>
<link rel="manifest" href="manifest.json">
<style>
/* ===== Theme + sizing (v36 Glow) ===== */
:root{
  --bg:#1a232b;
  --card:rgba(255,255,255,0.03);
  --glass:rgba(167,139,250,0.10);
  --purple:#a78bfa;
  --purple-2:#8b5cf6;
  --muted:#cbd5e1;
  --accent:#8b5cf6;
  --btn-text-size:18px;
  --body-text-size:16px;
  --title-size:20px;
  --fade-dur:0.5s;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  background:var(--bg);
  color:var(--muted);
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:28px;
  overflow-y:auto;
  animation: pageFade var(--fade-dur) ease both;
  /* subtle lavender radial glow during fade-in */
  background-image: radial-gradient(circle at 50% 15%, rgba(167,139,250,0.06), transparent 35%);
}

/* fade-in animation (global) */
@keyframes pageFade {
  from { opacity: 0; filter: blur(6px); }
  to   { opacity: 1; filter: blur(0); }
}

/* container */
.container{width:100%;max-width:980px;}
.cab{border-radius:12px 12px 0 0;overflow:hidden;height:150px;background:#111;display:flex;align-items:center;justify-content:center}
.cab img{width:100%;height:150px;object-fit:cover;display:block}
.card{
  background:var(--card);
  backdrop-filter:blur(6px);
  padding:22px;
  border-radius:0 0 12px 12px;
  box-shadow:0 12px 40px rgba(0,0,0,.6);
}

/* layout & readability */
.row{display:grid;grid-template-columns:1fr;gap:16px}
h3{font-size:var(--title-size);margin:0 0 8px 0}
.small{font-size:0.85rem;color:#d6d9e0}
.footer-note{font-size:12px;color:#9aa4b2;margin-top:10px;text-align:center;display:none}

/* buttons (25% larger than before) */
.btn{
  display:inline-block;
  padding:16px 18px;
  border-radius:14px;
  border:0;
  font-weight:700;
  cursor:pointer;
  font-size:var(--btn-text-size);
  transition: transform .12s ease, box-shadow .16s ease;
  user-select:none;
}
.btn:active{ transform:scale(.98) } /* quick tap feedback */
.btn-primary{
  background:linear-gradient(90deg,var(--purple),var(--purple-2));
  color:white;
  box-shadow:0 6px 20px rgba(139,92,246,0.12);
}
.btn-white{
  background:rgba(255,255,255,0.03);
  color:white;
  border:1px solid rgba(167,139,250,0.08);
}
.btn-gray{ background:#2b3440;color:white }
.btn-danger{ background:#ef4444;color:white }

/* pulse glow on hover/focus */
.btn-primary:hover, .btn-primary:focus,
.btn-white:hover, .btn-white:focus {
  animation: pulseGlow 1s ease;
  box-shadow: 0 8px 30px rgba(139,92,246,0.16), 0 0 18px rgba(139,92,246,0.08);
}
@keyframes pulseGlow{
  0% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-2px) scale(1.01); }
  100% { transform: translateY(0) scale(1); }
}

/* inputs */
.input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.04);
  background:transparent;
  color:var(--muted);
  font-size:var(--body-text-size);
}

/* list item */
.list-item{
  background:var(--glass);
  padding:14px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid rgba(167,139,250,0.12);
  margin-bottom:10px;
}

/* calendar grid */
.calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
  align-items:start;
}
.calendar .day {
  background:rgba(255,255,255,0.02);
  border-radius:10px;
  padding:8px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  gap:6px;
  min-height:78px;
  aspect-ratio: 1 / 1; /* ensures square cells and prevents overflow */
  position:relative;
  transition: transform .12s ease, box-shadow .12s ease;
}
.calendar .day:hover { transform: translateY(-4px); box-shadow:0 12px 30px rgba(0,0,0,.45) }
.day .num{ font-weight:700; text-align:right; color:var(--muted) }
.day .items{ font-size:13px; color:#e6edf3; display:flex; flex-direction:column; gap:4px; overflow:hidden; }

/* indicator glow under day number for days with appointments */
.day .glow-dot{
  width:8px;height:8px;border-radius:50%;background:var(--purple);
  position:absolute; left:50%; transform:translateX(-50%);
  bottom:10px;
  box-shadow: 0 0 12px rgba(167,139,250,0.9), 0 0 28px rgba(139,92,246,0.25);
}

/* fixed-back removed (we keep button below calendar but not overlapping) */
.calendar-footer{
  display:flex;
  justify-content:center;
  margin-top:10px;
}

/* bigger text in main lists */
.list-item .name{ font-size:18px; font-weight:700; color:var(--purple) }
.list-item .time{ font-size:14px; color:#e6edf3 }

/* modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999 }
.modal-card{ background:rgba(20,24,30,0.95); border:1px solid rgba(167,139,250,0.14); padding:18px; border-radius:12px; color:var(--muted); max-width:640px; width:94%; }

/* responsive smaller screens: reduce sizes but keep readability */
@media (max-width:520px){
  :root{ --btn-text-size:16px; --body-text-size:14px; --title-size:18px; }
  .calendar .day{ aspect-ratio: 1 / 1; min-height:64px; }
  .cab img{height:110px}
}
</style>
</head>
<body>

<div class="container fade-target">
  <div class="cab"><img src="cabecera.png" alt="Cabecera"></div>
  <div class="card">
    <div id="app" class="row"></div>
  </div>
</div>

<!-- audio alarm (looped by code) -->
<audio id="alarm" src="alarma.mp3" preload="auto"></audio>

<!-- App Script -->
<script>
/* ========== App logic (v36 PWA Glow) ========== */
const STORAGE_KEY = 'cataleya_v36_appointments';
let appointments = [];
let reminderTimer = null;

const app = document.getElementById('app');
const alarm = document.getElementById('alarm');

function fadePage(){ // apply fade-in (CSS global handles anim, but we retrigger when returning)
  document.documentElement.style.animation = 'none';
  void document.documentElement.offsetWidth;
  document.documentElement.style.animation = `pageFade var(--fade-dur) ease both`;
}

function showModal(text){
  const m = document.createElement('div'); m.className='modal';
  m.innerHTML = `<div class="modal-card"><div>${text.replace(/\\n/g,'<br>')}</div><div style="text-align:right;margin-top:12px"><button id="mclose" class="btn btn-primary">Entendido</button></div></div>`;
  document.body.appendChild(m);
  document.getElementById('mclose').onclick = ()=> {
    stopAlarmLoop();
    document.body.removeChild(m);
    fadePage();
  };
}

/* local storage helpers */
function ensureArray(v){ return Array.isArray(v) ? v : []; }
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    appointments = raw ? ensureArray(JSON.parse(raw)) : [];
    // normalize fields
    appointments = appointments.map(a=> Object.assign({notified:false}, a));
  }catch(e){ appointments = []; localStorage.removeItem(STORAGE_KEY); }
  return appointments;
}
function save(arr){
  try{
    appointments = ensureArray(arr);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appointments));
    // update SW
    if(navigator.serviceWorker && navigator.serviceWorker.controller){
      try{ navigator.serviceWorker.controller.postMessage({ type:'UPDATE_APPOINTMENTS', appointments }); }catch(err){ console.warn('post to SW failed', err); }
    }
    return true;
  }catch(e){ console.error(e); return false; }
}

/* UI renderers */
function renderHome(){
  fadePage();
  app.innerHTML = `
    <div style="display:grid;gap:12px">
      <button id="addBtn" class="btn btn-primary">AGENDAR NUEVA CITA</button>
      <button id="viewBtn" class="btn btn-white">VER CITAS</button>
      <button id="calBtn" class="btn btn-gray">VER CALENDARIO</button>
      <button id="cancelBtn" class="btn btn-danger">CANCELAR CITA</button>
    </div>`;
  document.getElementById('addBtn').onclick = renderAdd;
  document.getElementById('viewBtn').onclick = ()=>{ renderView(); location.hash=''; };
  document.getElementById('calBtn').onclick = renderCalendar;
  document.getElementById('cancelBtn').onclick = renderCancel;
}

function renderAdd(){
  fadePage();
  const now = new Date().toISOString().slice(0,16);
  app.innerHTML = `
    <h3>Agendar Cita</h3>
    <input id="name" class="input" placeholder="Nombre del cliente">
    <input id="date" type="datetime-local" class="input" value="${now}">
    <div style="display:flex;gap:8px;margin-top:6px">
      <button id="confirm" class="btn btn-primary">Confirmar Cita</button>
      <button id="back" class="btn btn-gray">Volver</button>
    </div>`;
  document.getElementById('back').onclick = ()=> (load(), renderHome());
  document.getElementById('confirm').onclick = async ()=>{
    const name = document.getElementById('name').value.trim();
    const date = document.getElementById('date').value;
    if(!name||!date) return showModal('‚ö†Ô∏è Debes completar todos los campos.');
    const dt = new Date(date);
    if(isNaN(dt.getTime())) return showModal('‚ùå Fecha inv√°lida');
    const apt = { id:`id-${Date.now()}-${Math.random().toString(16).slice(2)}`, name, dateTime: dt.toISOString(), createdAt:new Date().toISOString(), notified:false };
    const arr = ensureArray(load()); arr.push(apt);
    save(arr);
    showModal('‚úÖ La cita se registr√≥ con √©xito');
    startReminder();
    setTimeout(()=> renderHome(),900);
  };
}

function renderView(){
  fadePage();
  load();
  const now = Date.now();
  const list = appointments.filter(a=> new Date(a.dateTime).getTime() >= now).sort((a,b)=> new Date(a.dateTime) - new Date(b.dateTime));
  if(!list.length){
    app.innerHTML = `<p class="small">üí§ No hay citas programadas a partir de hoy.</p><button class="btn btn-gray" id="back">Volver</button>`;
    document.getElementById('back').onclick = ()=> renderHome();
    return;
  }
  app.innerHTML = `<div id="list"></div><div style="margin-top:10px"><button id="back" class="btn btn-gray">Volver</button></div>`;
  document.getElementById('back').onclick = ()=> renderHome();
  const listEl = document.getElementById('list');
  list.forEach(a=>{
    const item = document.createElement('div'); item.className='list-item';
    item.innerHTML = `<div><div class="name">${a.name}</div><div class="time">${new Date(a.dateTime).toLocaleString()}</div></div><div><button class="btn btn-danger" data-id="${a.id}">Cancelar</button></div>`;
    listEl.appendChild(item);
  });
  listEl.querySelectorAll('button').forEach(b=> b.onclick = (e)=>{
    const id = e.currentTarget.dataset.id;
    const arr = ensureArray(load()).filter(x=> x.id !== id);
    save(arr);
    renderView();
  });
}

function renderCalendar(){
  fadePage();
  load();
  // compute month grid for currentCalendarDate
  const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
  const first = new Date(y,m,1).getDay() || 7; // monday-offset safe
  const days = new Date(y,m+1,0).getDate();
  const map = appointments.reduce((acc,b)=>{ const k=b.dateTime.slice(0,10); (acc[k]=acc[k]||[]).push(b); return acc; }, {});
  let gridHtml = '';
  for(let i=1;i<first;i++) gridHtml += '<div></div>';
  for(let d=1; d<=days; d++){
    const key = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayItems = (map[key]||[]).sort((a,b)=> new Date(a.dateTime)-new Date(b.dateTime));
    const itemsHtml = dayItems.slice(0,3).map(x=>`<div>${x.name} - ${new Date(x.dateTime).toLocaleTimeString()}</div>`).join('');
    const glow = dayItems.length ? `<div class="glow-dot"></div>` : '';
    gridHtml += `<div class="day" onclick="showDay('${key}')"><div class="num">${d}</div><div class="items">${itemsHtml}</div>${glow}</div>`;
  }
  app.innerHTML = `<h3 style="text-align:center">${currentCalendarDate.toLocaleDateString(undefined,{month:'long',year:'numeric'})}</h3>
    <div class="calendar">${gridHtml}</div>
    <div class="calendar-footer"><button id="back" class="btn btn-primary">‚¨ÖÔ∏è Volver al men√∫</button></div>`;
  document.getElementById('back').onclick = ()=> renderHome();
}

function renderCancel(){
  fadePage();
  load();
  if(!appointments.length){
    app.innerHTML = '<p class="small">No hay citas.</p><button class="btn btn-gray" id="back">Volver</button>';
    document.getElementById('back').onclick = ()=> renderHome();
    return;
  }
  app.innerHTML = appointments.map(a=>`<div class="list-item"><div><div class="name">${a.name}</div><div class="time">${new Date(a.dateTime).toLocaleString()}</div></div><div><button class="btn btn-danger" data-id="${a.id}">Cancelar</button></div></div>`).join('')+`<div style="margin-top:10px"><button class="btn btn-gray" id="back">Volver</button></div>`;
  document.getElementById('back').onclick = ()=> renderHome();
  document.querySelectorAll('[data-id]').forEach(b=> b.onclick = (e)=>{ const id = e.currentTarget.dataset.id; const arr = ensureArray(load()).filter(x=> x.id !== id); save(arr); renderCancel(); });
}

function showDay(k){
  load();
  const list = appointments.filter(a=> a.dateTime.startsWith(k)).sort((a,b)=> new Date(a.dateTime)-new Date(b.dateTime));
  if(!list.length) return showModal('No hay citas en esta fecha.');
  showModal(list.map(a=> `${a.name} - ${new Date(a.dateTime).toLocaleTimeString()}`).join('\\n'));
}

/* ====== Alarm controls ====== */
function playAlarmLoop(){ try{ alarm.loop = true; alarm.currentTime = 0; alarm.play().catch(()=>{}); }catch(e){} }
function stopAlarmLoop(){ try{ alarm.pause(); alarm.currentTime = 0; }catch(e){} }

/* ====== Reminder logic: check every 60s (client-side) and ask SW to show notifications for background ====== */
function startReminder(){
  if(reminderTimer) return;
  const check = ()=>{
    load();
    const now = Date.now();
    const upcoming = appointments.filter(a=>{
      const t = new Date(a.dateTime).getTime();
      const diff = t - now;
      return diff > 0 && diff <= 5*60*1000 && !a.notified;
    });
    upcoming.forEach(a=>{
      a.notified = true;
      const dateStr = new Date(a.dateTime).toLocaleString('es-ES',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
      const title = `üîî Cita con ${a.name}`;
      const body = `üíú Recuerda tu cita el ${dateStr}`;
      const options = { body, icon:'icono192.png', badge:'icono192.png', data:{ id: a.id }, requireInteraction:true };
      // via SW if available (better background behavior) else Notification API
      if(navigator.serviceWorker && navigator.serviceWorker.controller){
        try{ navigator.serviceWorker.controller.postMessage({ type:'SHOW_NOTIFICATION', title, options }); }catch(e){ try{ new Notification(title, options); }catch(e){} }
        try{ navigator.serviceWorker.controller.postMessage({ type:'PLAY_ALARM_SOUND' }); }catch(e){} // ask clients to play sound
      } else {
        try{ new Notification(title, options); playAlarmLoop(); }catch(e){}
      }
    });
    save(appointments);
  };
  check();
  reminderTimer = setInterval(check, 60*1000); // check every minute for a bit more responsiveness
}

/* ===== Service Worker registration & messaging ===== */
async function registerSW(){
  if('serviceWorker' in navigator){
    try{
      const reg = await navigator.serviceWorker.register('service-worker.js');
      console.log('SW registered', reg);
      // push current appointments to SW
      if(reg.active) reg.active.postMessage({ type:'UPDATE_APPOINTMENTS', appointments: load() });
      // messages from SW
      navigator.serviceWorker.addEventListener('message', ev=>{
        if(!ev.data) return;
        if(ev.data.type === 'PLAY_ALARM_SOUND'){ playAlarmLoop(); }
        if(ev.data.type === 'STOP_ALARM_SOUND'){ stopAlarmLoop(); }
      });
    }catch(e){ console.warn('SW register failed', e); }
  }
}

/* if opened via notification (url hash #view) -> go to view and stop alarm */
function handleOpenFromNotification(){
  if(location.hash === '#view'){
    stopAlarmLoop();
    renderView();
    // clean hash to avoid repeated behavior
    history.replaceState(null, '', location.pathname + location.search);
  }
}

/* show modal for recent alerts when opening app normally */
function checkRecentAlerts(){
  load();
  const now = Date.now();
  const recent = appointments.filter(a=>{
    const t = new Date(a.dateTime).getTime();
    return now >= t && (now - t) <= 30*60*1000 && a.notified;
  });
  if(recent.length){
    const msg = recent.map(a=>`üíú Ten√≠as una cita con ${a.name} el ${new Date(a.dateTime).toLocaleString('es-ES',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})}`).join('\\n\\n');
    showModal(msg);
    stopAlarmLoop();
  }
}

/* Permission request helper */
function ensureNotificationPermission(){ if(Notification.permission !== 'granted') Notification.requestPermission().catch(()=>{}); }

/* ===== Init ===== */
let currentCalendarDate = new Date();
document.addEventListener('DOMContentLoaded', ()=>{
  load();
  registerSW();
  ensureNotificationPermission();
  // if opened from notification ‚Üí go direct to view
  handleOpenFromNotification();
  // normal startup
  if(location.hash !== '#view') renderHome();
  // start reminder if any upcoming
  if(appointments.some(a=> new Date(a.dateTime).getTime() > Date.now())) startReminder();
  // check recent alerts a bit after load
  setTimeout(()=> checkRecentAlerts(), 800);
});

// expose showDay to global for onclick in calendar cells
window.showDay = showDay;
</script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cataleya Citas</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#1a232b; --card:rgba(255,255,255,0.03); --glass:rgba(167,139,250,0.10);
  --purple:#a78bfa; --purple-2:#8b5cf6; --muted:#cbd5e1; --accent:#8b5cf6;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:var(--bg);color:var(--muted);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;display:flex;align-items:flex-start;justify-content:center;padding:28px;}
.container{width:100%;max-width:920px;}
.cab{border-radius:12px 12px 0 0;overflow:hidden;height:150px;background:#111;display:flex;align-items:center;justify-content:center}
.cab img{width:100%;height:150px;object-fit:cover;display:block}
.card{background:var(--card);backdrop-filter:blur(6px);padding:20px;border-radius:0 0 12px 12px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
.row{display:grid;grid-template-columns:1fr;gap:12px}
.btn{display:block;width:100%;padding:14px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--purple),var(--purple-2));color:white}
.btn-white{background:rgba(255,255,255,0.03);color:white;border:1px solid rgba(167,139,250,0.08)}
.btn-gray{background:#2b3440;color:white}
.btn-danger{background:#ef4444;color:white}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
.list-item{background:var(--glass);padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(167,139,250,0.12);margin-bottom:8px}
.small{font-size:13px;color:#e6e9ef}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center}
.modal-card{background:rgba(20,24,30,0.9);border:1px solid rgba(167,139,250,0.14);padding:18px;border-radius:12px;color:var(--muted);backdrop-filter:blur(6px);max-width:520px;width:100%}
.calendar-footer{display:flex;justify-content:center;padding-top:12px;margin-top:12px}
.footer-note{font-size:12px;color:#9aa4b2;margin-top:10px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="cab"><img src="cabecera.png" alt="Cabecera"></div>
  <div class="card">
    <div id="app" class="row"></div>
  </div>
</div>

<!-- audio for reminders - will loop when requested -->
<audio id="alarm" src="alarma.mp3" preload="auto" loop></audio>

<!-- App script -->
<script>
const STORAGE_KEY = 'cataleya_v35_appointments';
let appointments = [];
let reminderTimer = null;
let playingAlarm = false;

const app = document.getElementById('app');
const alarm = document.getElementById('alarm');

function showModal(text){
  const m = document.createElement('div'); m.className='modal'; m.innerHTML=`
    <div class="modal-card"><div id="modal-content">${text.replace(/\n/g,'<br>')}</div><div style="text-align:right;margin-top:12px"><button id="mclose" class="btn btn-primary">Entendido</button></div></div>`;
  document.body.appendChild(m);
  document.getElementById('mclose').onclick = ()=> {
    stopAlarmLoop();
    document.body.removeChild(m);
  };
}

function ensureArray(v){ return Array.isArray(v)? v : []; }

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    appointments = ensureArray(parsed).map(a=>{
      return { id:a.id, name:a.name, dateTime:a.dateTime, createdAt:a.createdAt || null, notified:!!a.notified };
    });
  }catch(e){
    console.warn('load error', e);
    appointments = [];
    localStorage.removeItem(STORAGE_KEY);
  }
  return appointments;
}

function save(a){
  try{
    const arr = ensureArray(a);
    appointments = arr;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    if(navigator.serviceWorker && navigator.serviceWorker.controller){
      try{ navigator.serviceWorker.controller.postMessage({ type:'UPDATE_APPOINTMENTS', appointments: arr }); }catch(e){ console.warn('postMessage failed', e); }
    }
    return true;
  }catch(e){
    console.error(e); return false;
  }
}

// UI renderers
function renderHome(){
  app.innerHTML = `
    <button id="addBtn" class="btn btn-primary">AGENDAR NUEVA CITA</button>
    <button id="viewBtn" class="btn btn-white">VER CITAS</button>
    <button id="calBtn" class="btn btn-gray">VER CALENDARIO</button>
    <button id="cancelBtn" class="btn btn-danger">CANCELAR CITA</button>`;
  document.getElementById('addBtn').onclick = renderAdd;
  document.getElementById('viewBtn').onclick = renderView;
  document.getElementById('calBtn').onclick = renderCalendar;
  document.getElementById('cancelBtn').onclick = renderCancel;
}

function renderAdd(){
  const now = new Date().toISOString().slice(0,16);
  app.innerHTML = `
    <h3 style="color:white">Agendar Cita</h3>
    <input id="name" class="input" placeholder="Nombre del cliente">
    <input id="date" type="datetime-local" class="input" value="${now}">
    <button id="confirm" class="btn btn-primary">Confirmar Cita</button>
    <button id="back" class="btn btn-gray">Volver</button>`;
  document.getElementById('back').onclick = ()=> (load(), renderHome());
  document.getElementById('confirm').onclick = async ()=>{
    const name = document.getElementById('name').value.trim();
    const date = document.getElementById('date').value;
    if(!name || !date) return showModal('‚ö†Ô∏è Debes completar todos los campos.');
    const dt = new Date(date);
    if(isNaN(dt.getTime())) return showModal('‚ùå Fecha inv√°lida');
    const apt = { id: 'id-'+Date.now()+'-'+Math.random().toString(16).slice(2), name, dateTime: dt.toISOString(), createdAt: new Date().toISOString(), notified:false };
    const arr = ensureArray(load()); arr.push(apt);
    const ok = save(arr);
    if(ok){ showModal('‚úÖ La cita se registr√≥ con √©xito'); startReminder(); setTimeout(()=> renderHome(),900); } else showModal('‚ùå No se pudo guardar la cita');
  }
}

function renderView(){
  load();
  const now = Date.now();
  const list = appointments.filter(a=> new Date(a.dateTime).getTime() >= now).sort((a,b)=> new Date(a.dateTime)-new Date(b.dateTime));
  if(!list.length){
    app.innerHTML = `<p class="small">üí§ No hay citas programadas a partir de hoy.</p><button class="btn btn-gray" id="back">Volver</button>`;
    document.getElementById('back').onclick = ()=> renderHome();
    return;
  }
  app.innerHTML = `<div id="list"></div><button class="btn btn-gray" id="back">Volver</button>`;
  document.getElementById('back').onclick = ()=> renderHome();
  const listEl = document.getElementById('list');
  list.forEach(a=>{
    const item = document.createElement('div'); item.className='list-item';
    item.innerHTML = `<div><div style="color:var(--purple);font-weight:700">${a.name}</div><div class="small">${new Date(a.dateTime).toLocaleString()}</div></div><div><button class="btn btn-danger" data-id="${a.id}">Cancelar</button></div>`;
    listEl.appendChild(item);
  });
  listEl.querySelectorAll('button').forEach(b=> b.onclick = async (e)=>{
    const id = e.currentTarget.dataset.id;
    const arr = ensureArray(load()).filter(x=> x.id !== id);
    save(arr);
    renderView();
  });
}

function renderCalendar(){
  load();
  const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
  const first = new Date(y,m,1).getDay()||7, days = new Date(y,m+1,0).getDate();
  const map = appointments.reduce((acc,b)=>{ const k = b.dateTime.slice(0,10); (acc[k]=acc[k]||[]).push(b); return acc; }, {});
  let grid = '';
  for(let i=1;i<first;i++) grid += '<div></div>';
  for(let d=1; d<=days; d++){
    const key = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const da = (map[key]||[]).sort((a,b)=> new Date(a.dateTime)-new Date(b.dateTime));
    const items = da.slice(0,2).map(x=>`<div class='small'>${x.name} - ${new Date(x.dateTime).toLocaleTimeString()}</div>`).join('');
    grid += `<div class="list-item" onclick="showDay('${key}')"><div style="text-align:right;font-weight:700">${d}</div><div>${items}</div></div>`;
  }
  app.innerHTML = `<h3 style="color:white">${currentCalendarDate.toLocaleDateString(undefined,{month:'long',year:'numeric'})}</h3><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px">${grid}</div><div class="calendar-footer"><button id="back" class="btn btn-primary" style="font-size:18px;padding:12px 20px"><span style="margin-right:10px">‚¨ÖÔ∏è</span>Volver al men√∫</button></div>`;
  document.getElementById('back').onclick = ()=> renderHome();
}

function renderCancel(){
  load();
  if(!appointments.length){ app.innerHTML = '<p class="small">No hay citas.</p><button class="btn btn-gray" id="back">Volver</button>'; document.getElementById('back').onclick = ()=> renderHome(); return; }
  app.innerHTML = appointments.map(a=>`<div class="list-item"><div><div style="color:var(--purple);font-weight:700">${a.name}</div><div class="small">${new Date(a.dateTime).toLocaleString()}</div></div><div><button class="btn btn-danger" data-id="${a.id}">Cancelar</button></div></div>`).join('')+`<button class="btn btn-gray" id="back">Volver</button>`;
  document.getElementById('back').onclick = ()=> renderHome();
  document.querySelectorAll('[data-id]').forEach(b=> b.onclick = (e)=>{ const id = e.currentTarget.dataset.id; const arr = ensureArray(load()).filter(x=> x.id !== id); save(arr); renderCancel(); });
}

function showDay(k){
  load();
  const list = appointments.filter(a=> a.dateTime.startsWith(k)).sort((a,b)=> new Date(a.dateTime)-new Date(b.dateTime));
  if(!list.length) return showModal('No hay citas en esta fecha.');
  showModal(list.map(a=> `${a.name} - ${new Date(a.dateTime).toLocaleTimeString()}`).join('\n'));
}

// Alarm controls: loop sound until stopped
function playAlarmLoop(){
  try{
    alarm.loop = true;
    alarm.currentTime = 0;
    alarm.play().catch(()=>{});
    playingAlarm = true;
  }catch(e){ console.warn('play failed', e); playingAlarm=false; }
}
function stopAlarmLoop(){
  try{ alarm.pause(); alarm.currentTime = 0; playingAlarm = false; }catch(e){}
}

// Reminder logic: starts/continues a 5-minute checker and notifies 5 minutes before
function startReminder(){
  if(reminderTimer) return;
  const check = ()=>{
    load();
    const now = Date.now();
    const upcoming = appointments.filter(a=>{
      const t = new Date(a.dateTime).getTime();
      const diff = t - now;
      return diff > 0 && diff <= 5*60*1000 && !a.notified;
    });
    upcoming.forEach(a=>{
      // mark as notified in storage
      a.notified = true;
      // friendly message with full date
      const dateStr = new Date(a.dateTime).toLocaleString('es-ES',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
      const title = `üîî Cita con ${a.name}`;
      const body = `üíú Recuerda tu cita el ${dateStr}`;
      const options = { body, icon: 'icono192.png', badge:'icono192.png', data:{ id:a.id } , requireInteraction: true };
      // Try via service worker for background notification
      if(navigator.serviceWorker && navigator.serviceWorker.controller){
        try{ navigator.serviceWorker.controller.postMessage({ type:'SHOW_NOTIFICATION', title, options }); }catch(e){ try{ new Notification(title, options); }catch(e){} }
      } else {
        try{ new Notification(title, options); }catch(e){} 
      }
      // if clients exist, request playing sound loop
      if(navigator.serviceWorker && navigator.serviceWorker.controller){
        try{ navigator.serviceWorker.controller.postMessage({ type:'PLAY_ALARM_SOUND' }); }catch(e){}
      }
    });
    // persist notified flags
    save(appointments);
  };
  check();
  reminderTimer = setInterval(check, 5*60*1000);
}

// Service Worker registration and message handling
async function registerSW(){
  if('serviceWorker' in navigator){
    try{
      const reg = await navigator.serviceWorker.register('service-worker.js');
      console.log('SW registered', reg);
      // send initial appointments to SW
      if(reg.active){
        reg.active.postMessage({ type: 'UPDATE_APPOINTMENTS', appointments: load() });
      }
      navigator.serviceWorker.addEventListener('message', ev=>{
        if(ev.data && ev.data.type === 'PLAY_ALARM_SOUND'){
          // SW asks client to play sound loop
          playAlarmLoop();
        } else if(ev.data && ev.data.type === 'STOP_ALARM_SOUND'){
          stopAlarmLoop();
        }
      });
    }catch(e){ console.warn('SW register failed', e); }
  }
}

// When app opens after notification, check for recent appointments that were within last 30 minutes and show modal
function checkRecentAlerts(){
  load();
  const now = Date.now();
  const recent = appointments.filter(a=>{
    const t = new Date(a.dateTime).getTime();
    return now >= t && (now - t) <= 30*60*1000 && a.notified;
  });
  if(recent.length){
    const msg = recent.map(a=>`üíú Ten√≠as una cita con ${a.name} el ${new Date(a.dateTime).toLocaleString('es-ES',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})}`).join('\n\n');
    showModal(msg);
    // stop alarm if any
    stopAlarmLoop();
  }
}

// Request notification permission early (but non-intrusive)
function ensureNotificationPermission(){ if(Notification.permission !== 'granted') Notification.requestPermission().catch(()=>{}); }

// init
let currentCalendarDate = new Date();
document.addEventListener('DOMContentLoaded', ()=>{
  load();
  renderHome();
  registerSW();
  ensureNotificationPermission();
  // start reminder if any future appointments exist
  if(appointments.some(a=> new Date(a.dateTime).getTime() > Date.now())) startReminder();
  // check if opened after recent alert
  setTimeout(()=> checkRecentAlerts(), 800);
});

</script>
</body>
</html>
